---
科目:
课程名称:
tags: [计算机组成原理, 存储系统]
一轮复习情况: 进行中
二轮复习情况: 未开始
三轮复习情况: 未开始
难度:
考频:
备注:
---
# 03-存储系统

 >[!blank]
>- 03-1 存储器
>	- (一)[[#1. 存储器的分类|存储器的分类]]
>	- (二)[[#2. 存储器的性能指标|存储器的性能指标]]
>	- (三)[[#3. 多级层次的存储系统|多级层次的存储系统]]
>-  03-2 半导体随机存取存储器 #常考
>	- (一)[[#1. SRAM 存储器和 DRAM 存储器|SRAM 存储器和 DRAM 存储器]] #2015年 #2017年 #2018年 #2022年
>	- (二)[[#2. Flash 存储器|Flash 存储器]] #2012年
>-  03-3 主存储器 #近年修改
>	- (一)[[#1. ROM 存储器|ROM 存储器]] #2010年
>	- (二)[[#2. 多模块存储器|多模块存储器]] #2015年 #2017年
>	- (三)[[#3. 主存芯片的组成与连接|主存芯片的组成与连接]] #2009年 #2011年 #2016年 #2021年 #2023年
>- 03-4 外部存储器 #近年新增
>	- (一)[[#1. 磁盘存储器 (HDD)|磁盘存储器 (HDD)]] #2013年 #2015年 #2019年
>	- (二)[[#2. 固态硬盘【SSD】|固态硬盘【SSD】]]
>- 03-5 高速缓冲存储器(Cache) #必考
>	- (一)[[#1. 程序访问的局部性原理|程序访问的局部性原理]] #2017年
>	- (二)[[#2. Cache 的基本工作原理|Cache 的基本工作原理]] #2009年
>	- (三)[[#3. Cache 和主存之间的映射方式|Cache 和主存之间的映射方式]] #2009年 #2014年 #2022年
>	- (四)[[#4. Cache 中主存块的替换算法|Cache 中主存块的替换算法]] #2012年
>	- (五)[[#5. Cache 的写策略|Cache 的写策略]] #2015年 #2021年
>	- (六)[[#6. Cache 性能分析|Cache 性能分析]] #2009年 #2016年
>- 03-6 虚拟存储器 #近年修改 #常考
>	- (一)[[#1. 虚拟存储器的基本概念|虚拟存储器的基本概念]] #2010年 #2024年
>	- (二)[[#2. 页式虚拟存储器基本原理、页表、地址转换、TLB【快表】|页式虚拟存储器基本原理、页表、地址转换、TLB【快表】]] #2013年 #2015年 #2019年 #2022年 #2024年
>	- (三)[[#3. 段式虚拟存储器的基本原理|段式虚拟存储器的基本原理]]
>	- (四)[[#4. 段页式虚拟存储器的基本原理|段页式虚拟存储器的基本原理]]

---

## **03-1 存储器**

### **1. 存储器的分类**
![[01-Projects/00 考研/02-计算机组成原理/存储器的分类|1000]]
*   **按存储介质分**：
    *   **半导体存储器**：用半导体电路（晶体管、电容）存储信息，速度快，但断电易失 (SRAM、DRAM) 或非易失 (Flash)。
    *   **磁表面存储器**：用磁性材料存储信息，容量大，价格便宜，非易失 (HDD、磁带)。
    *   **光存储器**：用激光读写光盘上的信息 (CD、DVD、蓝光光盘)。
*   **按存取方式分**： #2011年
    *   **随机存取存储器 (RAM - Random Access Memory)**：
        *   **特点**：可以对任何一个存储单元进行**随机访问**，存取时间与存储单元的物理位置**无关**。
        *   **典型设备**：RAM、ROM、Flash。
    *   **顺序存取存储器 (SAM - Sequential Access Memory)**：
        *   **特点**：只能按**顺序存取**信息，访问时间与存储位置**线性相关**。
        *   **典型设备**：磁带、CD-ROM。
    *   **直接存取存储器 (DAM - Direct Access Memory)**：
        *   **特点**：介于随机存取和顺序存取之间。先直接定位到某个大致的区域，再在该区域内顺序查找。
        *   **典型设备**：硬盘 (HDD)。
    *   **相联存储器 (CAM - Content Addressable Memory)**：
        *   **特点**：按**内容寻址**，并行地与所有存储单元内容比较。
        *   **应用**：Cache 中的地址转换 (Tag 查找)，TLB (快表)。

**存取方式分类对比** #2011年

| 存取方式 | 定义                     | 时间特性               | 典型设备         |
| :------- | :----------------------- | :--------------------- | :--------------- |
| 随机存取 | 访问时间与存储位置无关 | 恒定访问时间 `O(1)` | RAM、ROM、Flash  |
| 顺序存取 | 必须按顺序访问数据       | 访问时间与位置线性相关 | 磁带、CD-ROM     |
| 直接存取 | 先定位到区域再顺序访问   | 访问时间部分相关       | 硬盘 (HDD)       |
| 相联存取 | 按内容并行查找           | 恒定访问时间 `O(1)` | TLB、Cache 标记 |

*   **按在计算机中的作用分**：
    *   **内存储器 (主存储器)**：CPU 能**直接访问**的存储器，速度快，容量相对小。包括主存和高速缓存 (Cache)。
    *   **外存储器 (辅助存储器)**：CPU 不能直接访问，需要先调入内存才能使用。容量大，速度慢，价格便宜。包括硬盘、U盘、SSD。
*   **按断电后信息的可保存性分类**：
    *   **易失性存储器 (Volatile Memory)**：电源关闭时信息自动丢失。例如 RAM (SRAM、DRAM)、Cache。
    *   **非易失性存储器 (Non-Volatile Memory)**：信息可一直保留，不需要电源维持。例如 ROM、磁表面存储器、光存储器、闪存 (SSD、U盘)。
*   **按读写功能分**：
    *   **只读存储器 (ROM - Read-Only Memory)**：只能读不能写（或只能写一次，或擦写很麻烦）。
    *   **读写存储器 (RAM - Read-Write Memory)**：可读可写，是我们最常用的内存。

### **2. 存储器的性能指标**
*   **存储容量 (Capacity)**：能存储的信息量，如 `GB`、`TB`。
*   **存取时间 (Access Time)**：
    *   **定义**：从CPU发出读写命令到完成操作所需的时间。
    *   **构成**：通常包括**寻址时间**和**传输时间**。
*   **存取周期 (Cycle Time)**：
    *   **定义**：连续两次独立的存储器操作（如读/写）所需的最小时间间隔。
    *   **特点**：比存取时间略长，因为它还包括**恢复数据或准备下一次操作**的时间。
*   **存储器带宽 (Bandwidth)**：
    *   **定义**：单位时间内存储器存取的信息量，衡量存储器"吞吐量"。
    *   **单位**：通常用 `MB/s` 或 `GB/s`。
    *   **计算**：`带宽 = (数据总线宽度 / 8) × (1 / 存取周期)`。

### **3. 多级层次的存储系统**
![[考研学习笔记02-计算机组成原理 03-存储系统 今天09_44.png]]
![[考研学习笔记02-计算机组成原理 03-存储系统 今天09_42.png]]
*   **顶层 (最快、最小、最贵)**：**CPU 寄存器**。
*   **第二层**：**高速缓存 (Cache)**，由 SRAM 组成，速度快，容量比寄存器大，比主存小。
*   **第三层**：**主存储器 (Main Memory / RAM)**，由 DRAM 组成，速度比 Cache 慢，容量更大。
*   **底层 (最慢、最大、最便宜)**：**辅助存储器 (Auxiliary Memory / 外存)**，如硬盘、SSD。
*   **核心思想**：利用**局部性原理**，将常用数据在不同速度和容量的存储器之间进行动态调度。
    *   **时间局部性 (Temporal Locality)**：被访问过的数据很可能在短时间内再次被访问。
    *   **空间局部性 (Spatial Locality)**：被访问过的数据附近的地址数据也很可能很快被访问。

**存储器层次结构对比** #2024年

| 对比维度           | Cache-主存层次                | 主存-外存层次 (虚拟存储器)       |
| :----------------- | :---------------------------- | :------------------------------- |
| **主要目的**       | 提高访问速度                  | 扩展容量，内存保护，多道程序管理 |
| **交换单位**       | **块/行** (Block/Line)        | **页/段** (Page/Segment)         |
| **管理方式**       | 硬件自动管理                  | 硬件 (MMU) + 软件 (操作系统) 管理 |
| **映射方式**       | 直接、组相联、全相联          | 通常采用**全相联**               |
| **替换算法实现**   | **硬件实现** (追求速度)       | **软件实现** (追求灵活性)        |
| **写策略**         | 全写法 (Write-Through) 或写回法 (Write-Back) | 通常采用**写回法** (减少外存访问) |
| **缺失处理时间**   | 纳秒级 (Cache Miss Penalty)   | 毫秒级 (Page Fault Penalty)      |
| **透明性**         | 对程序员透明                  | 对程序员透明                     |

---

## **03-2 半导体随机存取存储器**

### **1. SRAM 存储器和 DRAM 存储器**
*   **SRAM (Static RAM - 静态随机存取存储器)**：
    *   **原理**：利用**双稳态触发器**（通常由 6 个晶体管组成）存储信息。只要供电，数据就能稳定保持。
    *   **特点**：
        *   **速度快**：存取时间短，与 CPU 速度接近。
        *   **功耗高**：晶体管多，耗电量大。
        *   **集成度低**：每个存储单元占用的空间大，容量小。
        *   **价格贵**：成本高。
        *   **不需要周期性刷新**：数据稳定。
    *   **应用**：主要用于**高速缓存 (Cache)** 和寄存器。
*   **DRAM (Dynamic RAM - 动态随机存取存储器)**：
    *   **原理**：利用**电容**存储电荷来存储信息。电容会漏电，电荷会慢慢消失，需要**周期性地刷新（充电）**才能保持数据。每个存储单元通常由一个**晶体管**和一个**电容 (1T1C)** 组成。
    *   **特点**：
        *   **速度相对慢**：比 SRAM 慢，但比外存快。
        *   **功耗低**：集成度高。
        *   **集成度高**：每个存储单元占用的空间小，相同面积下容量大。
        *   **价格便宜**：成本低。
        *   **需要周期性刷新**：这是它最大的特点，也是"动态"的由来。
    *   **应用**：主要用于**主存储器（内存条）**。

**刷新机制技术对比** #2015年

| 存储器类型 | 存储机制             | 刷新需求 | 刷新原因             |
| :--------- | :------------------- | :------- | :------------------- |
| SRAM       | 双稳态触发器 (6T)  | 不需要   | 触发器自维持，无电荷泄漏 |
| DRAM/SDRAM | 电容存储 (1T1C)    | **需要** | 电容漏电导致数据衰减 |
| ROM        | 熔丝/掩膜等固化结构  | 不需要   | 物理结构固化，数据永久 |
| Flash Memory | 浮栅电荷存储 (浮栅MOS) | 不需要   | 浮栅隔离良好，电荷长期保持 |

> [!key] **DRAM 地址复用技术** #2014年 #2018年 #2022年
> *   **目的**：为了减少 DRAM 芯片的**地址引脚数量**，降低封装成本和布线复杂度。
> *   **原理**：DRAM 内部存储单元按二维矩阵（行和列）排列。地址信号分两次传送：
>     1.  先传送**行地址**，并由 `RAS` (Row Address Strobe, 行地址选通) 信号锁存。
>     2.  再传送**列地址**，并由 `CAS` (Column Address Strobe, 列地址选通) 信号锁存。
> *   **引脚数量计算**：
>     *   理论地址线数 $N = \log_2(\text{容量字数})$。
>     *   实际地址引脚数 $N_{\text{实际}} = N / 2$ (当行列地址位数相等时，即方阵结构)。
>     *   对于 $r \times c$ 的存储阵列，地址引脚数 $N_{\text{引脚}} = \text{max}(\log_2 r, \log_2 c)$。
> *   **优势**：大幅减少了引脚数量（约减半），从而降低了芯片成本和尺寸。
> *   **缺点**：地址分时传送，增加了存取时间。

**DRAM 与 SRAM 引脚对比** #2014年

| 存储器类型 | 地址线特点             | 引脚数量优化             | 技术优势             |
| :--------- | :--------------------- | :----------------------- | :------------------- |
| DRAM       | 地址复用，行列分时传输 | 地址线减半               | 封装小，成本低，容量大 |
| SRAM       | 地址线直接引出         | 地址线全部引出 (无复用)  | 访问速度快           |
| ROM/EPROM  | 地址线直接引出         | 地址线全部引出 (无复用)  | 结构简单，非易失     |

> [!key] **DRAM 芯片最优行列配置** #2018年
> *   **优化目标**：地址引脚最少，刷新开销最小。
> *   **地址引脚最少**：选择 $\text{max}(\log_2 r, \log_2 c)$ 值最小的行列配置。
> *   **刷新开销最小**：DRAM 按行刷新，刷新开销与行数 $r$ 成正比。因此行数越少刷新开销越小。
> *   **综合决策**：在满足总容量 $r \times c$ 约束下，优先考虑地址引脚最少，若引脚数相同则选择行数最少的配置。

### **2. Flash 存储器**
*   **概念定义**：一种非易失性半导体存储器，属于 EEPROM 的变种，可以按**块**擦除，按**页**编程。
*   **存储结构**：存储元由**浮栅 MOS 晶体管**组成，利用浮栅中电荷的俘获和释放来存储信息。
*   **数据保持性**：**非易失性存储器**，断电后信息不丢失，数据可长期保持。
*   **访问方式**：采用**随机访问**方式，可直接通过地址线访问任意存储单元。
*   **应用**：广泛应用于固态硬盘 (SSD)、U 盘、手机存储等。

**闪存技术细节对比** #2012年

| 操作类型 | 速度特性     | 技术限制/原理                        | 典型时间     |
| :------- | :----------- | :----------------------------------- | :----------- |
| 读操作   | **快速**     | 直接感应浮栅电荷状态                 | 纳秒级       |
| 写操作   | **较慢**     | 需要隧道效应注入电子，且需先**擦除块** | 微秒到毫秒级 |
| 擦除操作 | **最慢**     | 必须按块擦除，高压去除电荷           | 毫秒级       |

> [!danger] **闪存读写速度不对等** #2012年
> *   闪存的读写速度**不一样快**，读操作远快于写操作。
> *   写操作需要先执行块擦除，这个过程耗时较长，是闪存写入慢的主要原因。

---

## **03-3 主存储器**

### **1. ROM 存储器**
*   **概念定义**：只读存储器，一种非易失性存储器，主要用于存放固件、BIOS 等不常更改的程序。
*   **特性**：
    *   **非易失性**：断电后数据不丢失。
    *   **随机存取**：虽然是只读，但支持随机访问，访问时间与地址无关。
    *   **只读**：通常只能读，或编程/擦除需要特殊操作。
*   **RAM 与 ROM 比较** #2010年

| 特性维度          | RAM 分析           | ROM 分析      | 技术原理      |
| :------------ | :--------------- | :---------- | :-------- |
| **易失性**       | 断电数据丢失           | 断电数据保持      | 存储介质物理特性  |
| **访问模式**      | 随机存取 `O(1)`      | 随机存取 `O(1)` | 地址译码直接访问  |
| **Cache 适用性** | 高速访问适合 (SRAM)    | 速度慢不适合      | 访问速度和成本考虑 |
| **刷新机制**      | DRAM 需要，SRAM 不需要 | 完全不需要       | 电荷保持机制差异  |
| **读写能力**      | 可读可写             | 只读 (或擦写复杂)  | -         |

### **2. 多模块存储器**
*   **目的**：为了进一步提高存储器系统的存取速度和带宽，特别是在 CPU 连续访问大量数据时。
*   **核心思想**：将存储器系统划分为多个独立的存储体，使它们可以并行工作。

> [!key] **低位交叉编址 (Low-Order Interleaving / 交叉编址)** #2015年 #2017年
> *   **概念定义**：将连续的主存地址**分散**到多个独立的存储体中。地址的**低位部分**用于选择存储体号，地址的**高位部分**用于选择体内地址。
> *   **特点**：
>     *   **并行性**：非常适合**连续访问数据**。当 CPU 请求连续的多个数据时，这些数据可以被分散到不同的存储体中，从而实现**并行存取**。
>     *   **提高带宽**：能大幅提高存储器系统的带宽和吞吐率。
>     *   **访存冲突**：如果在一个存储周期内，对**同一个存储体**发出了多次访问请求，就会发生访存冲突，导致等待。
> *   **高位交叉编址 (High-Order Interleaving / 连续编址)**：
>     *   **概念定义**：地址的**高位部分**决定访问哪个存储体，低位部分决定在体内的地址。
>     *   **特点**：各存储体地址空间连续，适合程序模块化存储。访问一个连续的主存块时，各模块**不能被并行访问**，不能提高存储器的吞吐率。

**访存冲突分析** #2015年 #2017年
*   **概念定义**：在多体交叉存储器中，当**同一存储体**在**其存储周期内**接收到多个访存请求时，即发生冲突。
*   **判断标准**：
    1.  **模块号一致**：两个访存地址通过 `地址 MOD 存储体数` 计算出的模块号相同。
    2.  **时间重叠**：后一次访问请求的**启动时间**发生在前一次访问请求的**完成时间之前**，且两者涉及同一存储体。
*   **交叉编址计算技巧** #2017年
    *   **模块数确定**：`log₂(模块数)` 决定地址的低位有多少位用于模块编号。
    *   **数据分布**：`double` 类型变量（8字节）等，需要按字节/字数跨模块分析。
    *   **周期计算**：**跨行数**（或跨模块组数）决定所需的存储周期数。

### **3. 主存芯片的组成与连接**

*   **存储器芯片组成**：一个存储芯片通常包括存储体、地址译码器、读写控制逻辑、地址寄存器 (MAR) 和数据寄存器 (MDR) 等。
*   **CPU 与主存的总线连接**： #2021年 #2023年
    *   **地址总线 (Address Bus)**：CPU 向主存发送地址，**单向**（CPU -> 主存）。宽度决定了 CPU 的**最大可寻址空间** ($2^{\text{地址总线宽度}}$ 字节)。
    *   **数据总线 (Data Bus)**：CPU 和主存之间传输实际数据，**双向**。宽度决定了 CPU 一次能传输的**数据位数**。
    *   **控制总线 (Control Bus)**：CPU 发送读/写等控制信号，**双向**。

> [!key] **主存容量与芯片扩展技术** #2009年 #2016年 #2021年 #2023年
> *   **目的**：用有限容量、位宽的存储芯片组成所需容量、位宽的主存储器系统。
> *   **按字节编址**：最小寻址单位为 1 字节（8 位）。
> *   **位扩展 (Bit Expansion)**：
>     *   **目的**：增加存储器的**字长**（数据位数），以匹配 CPU 的数据总线宽度。
>     *   **方法**：将多个容量相同、数据位数较小的芯片**并联**起来。所有芯片的地址线和控制线并联，数据线各自独立连接到数据总线的不同位。
>     *   **芯片数**：`系统位宽 / 单片位宽`。
> *   **字扩展 (Word Expansion)**：
>     *   **目的**：增加存储器的**字数**（地址空间），以达到总容量要求。
>     *   **方法**：将多个容量相同、数据位数相同的芯片**串联（或堆叠）**起来。通过**地址译码器**，利用地址线的高位（或低位，取决于编址方式）来产生**片选信号 (CS)**，选择激活某个芯片。
>     *   **芯片数**：`总容量 / 单片容量`。
> *   **字位扩展 (Word-Bit Expansion)**：
>     *   **目的**：同时增加存储器的字数和字长。
>     *   **方法**：结合位扩展和字扩展。通常是先进行位扩展形成一个"组"，再对这些"组"进行字扩展。
>     *   **总芯片数**：`字扩展倍数 × 位扩展倍数`。

**存储器配置参数分析** #2009年 #2016年 #2021年

| 存储区域     | 容量需求             | 芯片规格       | 扩展分析                    | 计算公式                        |
| :----------- | :------------------- | :------------- | :-------------------------- | :------------------------------ |
| ROM 区       | `X KB × 8 位`        | `A K × 8 位` 芯片 | 字扩展：`X ÷ A` 片        | `需求容量 ÷ 单芯片容量`         |
| RAM 区       | `Y KB × 8 位`        | `B K × 4 位` 芯片 | 字位同扩：`(Y ÷ B) × (8 ÷ 4)` 片 | `(需求容量 ÷ 单片容量) × (系统位宽 ÷ 单片位宽)` |
| **MAR 位数** | **log₂ (地址空间字节数)** | 地址空间        | `MAR` 位数由**CPU 地址总线宽度**决定，而非物理内存大小。 | `log₂(2^n)` = `n`              |

> [!danger] **MAR 位数计算易错点** #2011年
> *   `MAR` 的位数是由 **CPU 的地址线数量（或系统设计的最大地址空间）** 决定的，而不是当前实际安装的物理内存容量。
> *   例如，`64MB` 地址空间需要 $2^{26}$ 个字节地址，`MAR` 位数就是 26 位。

> [!key] **地址空间分配与 ROM/RAM 区划分** #2023年
> *   **总地址空间**：由 CPU 地址线位数 `n` 决定，为 $2^n$ 字节。
> *   **按比例划分**：将总地址空间按 `RAM:ROM` 比例划分出各自的容量。
> *   **地址范围确定**：根据区域容量和连续性要求，计算起始和结束地址。
>     *   `结束地址 = 起始地址 + 容量 - 1`。
> *   **十六进制转换**：熟练进行二进制与十六进制的转换。

---

## **03-4 外部存储器**

### *1. 磁盘存储器 (Magnetic Disk Storage) (传统硬盘HDD)
*   **概念定义**：基于磁性介质的非易失性存储设备，是计算机长期存储数据的主力军。
*   **基本结构**：盘片、磁头、磁头臂、主轴、控制器。
*   **数据存储格式**：磁道、扇区、柱面。**扇区是磁盘读写的最小单位**。
*   **磁盘容量**：
    *   **非格式化容量**：磁盘介质的物理存储能力。
    *   **格式化容量**：实际可存储用户数据的容量，小于非格式化容量（扣除了扇区标识、校验码等开销）。
*   **性能指标**：

> [!key] **磁盘存取时间计算** #2013年 #2015年
> *   **总存取时间 = 平均寻道时间 (Ts) + 平均旋转延迟 (Tr) + 数据传输时间 (Tt) + 控制器延迟 (Tc)**
> *   **平均寻道时间 (Ts)**：磁头从一个磁道移动到另一个磁道所需的时间，通常由题目给定。
> *   **平均旋转延迟 (Tr)**：磁头定位到正确磁道后，等待目标扇区旋转到磁头下方所需的时间。
>     *   `单圈周期 = 60 / 转速(RPM)`。
>     *   `平均旋转延迟 (Tr) = 单圈周期 / 2`。
> *   **数据传输时间 (Tt)**：磁头读写目标数据量所需的时间。
>     *   `Tt = 数据量 / 传输速率`。
>     *   `传输速率 = 磁盘转速 (r) × 每条磁道扇区数 × 每个扇区字节数`。
> *   **控制器延迟 (Tc)**：磁盘控制器处理 I/O 命令的固有延迟，通常由题目给定。

**磁盘性能参数计算** #2013年 #2015年

| 参数项目     | 给定数值 | 计算过程                                     | 结果 (示例)     |
| :----------- | :------- | :------------------------------------------- | :-------------- |
| 转速         | `10000rpm` | `10000 转/分 = 166.67 转/秒`                | `单圈周期 = 6ms` |
| 平均寻道时间 | `6ms`    | `Ts = 6ms` (题目给定)                        | `6ms`           |
| 平均旋转延迟 | -        | `6ms ÷ 2`                                    | `3ms`           |
| 传输时间     | `4KB÷20MB/s` | `4×1024÷(20×1024×1024)`                     | `≈ 0.2ms`       |
| 控制器延时   | `0.2ms`  | `Tc = 0.2ms` (题目给定)                      | `0.2ms`         |

> [!danger] **磁盘最小读写单位** #2019年
> *   磁盘是典型的**块存储设备**，其最小读写单位是**扇区**（通常 512 字节或 4KB），而非 1 字节。
> *   磁头无法精确定位到字节级别，且扇区包含校验码等信息，无法分割。

### 2. 固态硬盘【SSD】
*   **概念定义**：采用**闪存 (Flash Memory)** 芯片作为存储介质的新型外部存储器。
*   **优势**：
    *   **无机械部件**：抗震、无噪音、发热量低。
    *   **速度极快**：随机读写速度和持续读写速度远超 HDD。
    *   **存取时间短**：毫秒级甚至微秒级。
    *   **功耗低，体积小，重量轻**。
*   **缺点**：
    *   **价格相对较高**。
    *   **擦写寿命有限**：闪存芯片有有限的擦写次数 (P/E Cycle)。
        *   SLC (1位/单元) > MLC (2位/单元) > TLC (3位/单元) > QLC (4位/单元)。寿命依次递减。
    *   需要**磨损均衡 (Wear Leveling)** 和**垃圾回收 (Garbage Collection)** 机制。
*   **接口**：SATA (传统) 和 NVMe (基于 PCIe，高性能)。

---
## **03-5 高速缓冲存储器 (Cache)**

### **1. 程序访问的局部性原理** #2017年
*   **定义**：程序在执行时，访问存储器会呈现出局部性特征。CPU 访问的数据和指令往往集中在某个局部范围。
*   **时间局部性 (Temporal Locality)**：如果一个数据或指令被访问了，那么在**短时间内它很可能再次被访问**。
    *   **识别特征**：重复访问相同地址、循环中的重复引用。
*   **空间局部性 (Spatial Locality)**：如果一个数据或指令被访问了，那么它**附近的存储单元也很可能很快被访问**。
    *   **识别特征**：顺序访问、数组连续元素访问。
*   **Cache 的作用**：利用局部性原理，将 CPU 最近或即将要访问的数据和指令从慢速的主存中，预先或及时地拷贝到高速的 Cache 中。

### **2. Cache 的基本工作原理** #2009年
*   **命中 (Hit)**：CPU 在 Cache 中找到所需数据。
*   **缺失 (Miss)**：CPU 在 Cache 中未找到所需数据，需要从主存读取，并加载到 Cache。
*   **Cache 块/行 (Cache Block/Line)**：Cache 和主存之间进行数据交换的**最小单位**。
*   **Tag (标记)**：Cache 中的每个块的 Tag 用于标识这个 Cache 块对应的主存地址。

### **3. Cache 和主存之间的映射方式** #2009年 #2014年 #2022年
*   **概念定义**：规定主存中的一个数据块被拷贝到 Cache 中时，它应该放在 Cache 的哪个位置。
*   **CPU 地址结构**：`主存地址 = | Tag (标记) | Set Index (组索引/Cache块号) | Block Offset (块内地址) |`
*   **Cache 参数与地址划分** #2009年 #2022年

| 系统参数/字段    | 数值             | 位数计算                           | 地址字段作用           |
| :--------------- | :--------------- | :--------------------------------- | :--------------------- |
| Cache 总行数     | `N` 行           | -                                  | -                      |
| 相联路数         | `K` 路           | -                                  | 每组包含 Cache 块数    |
| 组数             | `N / K` 组       | `log₂(N/K)` 位                     | 组号字段位宽           |
| 块大小           | `B` 字节         | `log₂B` 位                         | 块内地址位宽           |
| 主存地址总位数   | `M` 位           | -                                  | -                      |
| **标记位数 (Tag)** | `M - log₂(N/K) - log₂B` | -                                | 高位，用于匹配判断     |
| **组号位数**     | `log₂(N/K)`      | -                                  | 中位，用于组选择       |
| **块内地址位数** | `log₂B`          | -                                  | 低位，用于块内寻址     |

*   **直接映射 (Direct Mapping)**：
    *   **规则**：主存块只能映射到 Cache 的**唯一一个特定块位置**上。`Cache块号 = 主存块号 MOD Cache总块数`。
    *   **地址分解**：`[Tag] [Cache块号] [块内地址]`。
    *   **优点**：实现简单，检查速度快。
    *   **缺点**：冲突频繁，命中率可能较低。
*   **全相联映射 (Fully Associative Mapping)**：
    *   **规则**：主存块可以映射到 Cache 的**任意一个空闲块位置**上。
    *   **地址分解**：`[Tag] [块内地址]` (Tag 即为虚页号，无 Cache 块号字段)。
    *   **优点**：灵活性高，Cache 利用率高，命中率高。
    *   **缺点**：查找复杂（需并行比较所有 Tag），成本高（需 CAM）。
*   **组相联映射 (Set Associative Mapping)**：
    *   **规则**：主存块只能映射到 Cache 的**唯一一个"组"**中，但在这个组内，它可以映射到**任意一个空闲块位置**。`Cache组号 = 主存块号 MOD Cache总组数`。
    *   **地址分解**：`[Tag] [Cache组号] [块内地址]`。
    *   **优点**：兼顾直接映射的简单和全相联映射的灵活性，性能较好。

> [!key] **Cache 比较器的个数和位数** #2022年
> *   **比较器个数**：在组相联映射中，比较器的个数等于**关联度（路数）**。因为在一个组内，需要同时比较所有路中的 Tag。
> *   **比较器位数**：比较器的位数等于**标记字段 (Tag) 的位数**。

> [!key] **指令 Cache 与数据 Cache 分离的目的** #2014年
> *   **主要目的**：**减少指令流水线资源冲突**。
> *   **背景**：在冯·诺伊曼结构中，指令和数据共享存储系统，当流水线同时需要取指令和访问数据时，会产生结构性冲突。
> *   **分离机制**：指令 Cache (I-Cache) 专门存储指令，数据 Cache (D-Cache) 专门存储数据，形成独立的访问通道。
> *   **效果**：取指部件可独立访问 I-Cache，而执行部件同时访问 D-Cache，消除了因共享存储资源导致的流水线停顿，从而提高流水线效率。

### **4. Cache 中主存块的替换算法** #2012年
*   **目的**：当 Cache 满时，选择一个块替换出去，为新调入的主存块腾出空间。
*   **基本原则**：根据局部性原理，尽量替换掉短期内最不可能被再次访问的块。
*   **常见算法**：
    *   **FIFO (First-In, First-Out)**：最先进入 Cache 的块，最先被替换。
    *   **LRU (Least Recently Used)**：最近最少使用的块，最先被替换。实现复杂，但命中率高，符合局部性原理。
    *   **LFU (Least Frequently Used)**：访问次数最少的块，最先被替换。
    *   **随机替换算法 (Random)**：随机选择一个块替换。

### **5. Cache 的写策略** #2015年 #2021年
*   **目的**：解决当 CPU 修改了 Cache 中的数据时，Cache 和主存数据不一致的问题。
*   **写直达法 (Write-Through)**：
    *   **原理**：当 CPU 写数据时，**同时写入 Cache 和主存**。
    *   **优点**：主存和 Cache 时刻保持一致，实现简单。
    *   **缺点**：每次写操作都要访问主存，速度慢，影响性能。
*   **写回法 (Write-Back)**：
    *   **原理**：当 CPU 写数据时，**只写入 Cache**，并标记该 Cache 块为"脏"(Dirty)。只有当该"脏"块被替换出 Cache 时，才将它写回主存。
    *   **优点**：CPU 写操作速度快，减少了写主存的次数。
    *   **缺点**：Cache 和主存可能暂时不一致，实现复杂，需要一个**脏位 (Dirty Bit)** 来标记。
*   **Cache 行控制位** #2015年 #2021年
    *   **标记位 (Tag)**：用于地址匹配。
    *   **有效位 (Valid Bit)**：标识该 Cache 行是否存储有效数据。
    *   **脏位 (Dirty Bit)**：写回法专用，标识 Cache 行数据是否被修改过（与主存不一致）。

> [!key] **Cache 总容量计算 (直接映射 + 回写策略)** #2015年 #2021年
> *   **Cache 总容量 (位数) = Cache 总行数 × (每行数据位数 + 每行控制位数)**
> *   **每行数据位数**：`主存块大小 (字节) × 8 (位/字节)`。
> *   **每行控制位数**：`标记位数 + 有效位 (1 位) + 脏位 (1 位)`。
> *   **标记位数**：`主存地址总位数 - 块内地址位数 - 行号位数`。
> *   **行号位数**：`log₂ (Cache 总行数)`。
> *   **块内地址位数**：`log₂ (主存块大小)`。

### **6. Cache 性能分析** #2009年 #2016年
*   **Cache 命中率 (Hit Rate, H)**：
    *   **概念定义**：CPU 访问 Cache 时，命中的次数占总访问次数的比例。
    *   **计算公式**：`H = 命中次数 / 总访问次数 = 命中次数 / (命中次数 + 未命中次数)`。
    *   **缺失率 (Miss Rate)**：`1 - H`。
*   **平均访存时间 (Average Memory Access Time, AMAT)**：
    *   **计算公式**：`AMAT = 命中时间 + 未命中率 × 未命中开销`
    *   `AMAT = 命中时间 + (1 - H) × (主存访问时间)`
    *   `命中时间`：CPU 从 Cache 中读取数据所需的时间。
    *   `主存访问时间`：CPU 从主存中读取数据所需的时间。
*   **影响 Cache 命中率的因素**：
    *   Cache 块大小、Cache 容量、映射方式、替换算法、程序的局部性原理、写策略（间接影响）。

---

## **03-6 虚拟存储器**

### **1. 虚拟存储器的基本概念** #2010年 #2024年
*   **目的**：
    1.  **扩展逻辑地址空间**：让每个程序都拥有一个独立、连续、非常大的内存空间，简化编程。
    2.  **实现内存保护**：程序间互相隔离，互不影响。
    3.  **实现多道程序共享主存**：允许多个程序同时加载并部分运行在主存中。
*   **核心思想**：通过**地址映射机制**，将**虚拟地址 (Virtual Address, VA)** 转换为**物理地址 (Physical Address, PA)**。
*   **MMU (Memory Management Unit)**：地址映射机构，负责虚拟地址到物理地址的转换。

> [!key] **MMU 地址转换流程** #2010年 #2024年
> 1.  **CPU 产生虚拟地址 (VA)**，分解为**虚拟页号 (VPN)** 和**页内偏移 (Offset)**。
> 2.  **MMU 并行查找 TLB** (Translation Lookaside Buffer)。
>     *   **TLB 命中**：MMU 从 TLB 获取**物理页框号 (PFN)**，与 Offset 组合形成**物理地址 (PA)**，CPU 访问 Cache/主存。
>     *   **TLB 未命中**：MMU 到**主存中**查找**页表**。
>         *   **页表命中（有效位 V=1）**：MMU 从页表获取 PFN，更新 TLB，组合 PA 访问 Cache/主存。
>         *   **页表未命中（有效位 V=0）**：发生**缺页中断 (Page Fault)**，CPU 控制权转移给**操作系统**。
>             *   操作系统从**外存**调入所需页面到主存。
>             *   更新页表项和 TLB。
>             *   **重新执行**导致缺页中断的指令。

> [!danger] **Cache 缺失不是在 MMU 地址转换过程中检测的** #2024年
> *   MMU 的职责是**虚拟地址到物理地址的转换**以及**访存权限检查**。
> *   **TLB 缺失**、**页面缺失**、**访问越权** 都是在 MMU 地址转换过程中检测的。
> *   **Cache 缺失**的检测发生在**物理地址生成之后**，由 Cache 控制器独立完成，与 MMU 的地址转换过程无关。

### **2. 页式虚拟存储器基本原理、页表、地址转换、TLB【快表】** #2013年 #2015年 #2019年 #2022年 #2024年
*   **原理**：将虚拟地址空间和物理地址空间都划分为**大小相等**的固定大小的块，分别称为**页 (Page)** 和**页框/物理块 (Page Frame)**。
*   **页大小 (Page Size)**：通常为 4KB。
*   **地址结构**：
    *   `虚拟地址 = | 虚拟页号 (Virtual Page Number, VPN) | 页内偏移 (Page Offset) |`
    *   `物理地址 = | 物理页框号 (Physical Frame Number, PFN) | 页内偏移 (Page Offset) |`
*   **页表 (Page Table)**：
    *   **概念定义**：存储在**主存中**，由操作系统为每个进程维护的数据结构，记录**VPN 到 PFN** 的映射关系。
    *   **页表项内容**：
        *   **物理页框号 (PFN)**：指向该虚拟页在主存中的实际物理位置。
        *   **有效位 (Valid Bit)**：指示该页是否已在主存中（1表示在，0表示不在）。
        *   **脏位 (Dirty Bit)**：指示该页在被加载到主存后是否被修改过。
        *   **访问权限位 (Protection Bits)**：指示该页的访问权限（读、写、执行）。
        *   **访问位 (Accessed Bit)**：指示该页是否被访问过，用于页替换算法。
*   **地址转换**：MMU 通过**页表**将虚拟页号映射为物理页框号。

> [!key] **TLB (Translation Lookaside Buffer) 快表** #2013年 #2015年 #2022年 #2024年
> *   **概念定义**：一个**高速缓存**，专门用于存放**页表项**（VPN 到 PFN 的映射关系），加速地址转换。它通常位于 MMU 内部。
> *   **结构**：TLB 结构类似于 Cache，也采用**映射方式**（如直接、组相联、全相联）。
> *   **TLB 表项内容**：通常包含：**标记 (Tag)**（虚拟页号的高位）、**物理页框号 (PFN)**、有效位、脏位等。
> *   **TLB 标记字段位数计算** #2024年
>     *   `TLB 标记位数 = 虚拟地址总位数 - TLB 索引位数 - 页内偏移位数`
>     *   `TLB 组数 = TLB 总表项数 / 组相联路数`
>     *   `TLB 索引位数 = log₂(TLB 组数)`
>     *   `页内偏移位数 = log₂(页大小)`

> [!danger] **缺页处理完成后，系统会重新执行引发缺页的指令** #2019年
> *   **概念定义**：当 MMU 检测到虚拟地址对应的页面不在物理内存中时，触发缺页异常。
> *   **处理过程**：由操作系统提供的缺页处理程序完成，包括从外存调入缺失页。
> *   **恢复执行**：缺页处理完成后，CPU 会将程序计数器 (PC) 恢复到引发缺页的指令地址，**重新执行该指令**，而不是跳转到下一条指令。这确保了缺页处理对用户程序的透明性。

> [!key] **访存次数计算 (虚拟存储器与 Cache)** #2015年
> *   **指令 "add xaddr, 3" (读-修改-写)**
> *   **最优情况 (最少访存次数)**：
>     1.  **地址转换 (TLB)**：如果 TLB 命中，**0 次主存访问**。
>     2.  **读操作 (Cache)**：如果 Cache 命中，**0 次主存访问**。
>     3.  **写操作 (Cache 写策略)**：
>         *   **写直达 (Write-Through)**：强制**1 次主存访问**（同时写入 Cache 和主存）。
>         *   **写回 (Write-Back)**：如果 Cache 命中，且块未被替换，**0 次主存访问**（只写 Cache）。若 Cache 块替换时才写回主存。
> *   **总结**：在 Cache 采用**写直达**策略时，执行包含写操作的指令，即使 TLB 和 Cache 都命中，也**至少需要 1 次主存访问**（用于写回）。

### **3. 段式虚拟存储器的基本原理**
*   **原理**：将虚拟地址空间划分为若干个**逻辑意义完整、大小不等**的段 (Segment)。
*   **地址结构**：`虚拟地址 = | 段号 | 段内偏移 |`
*   **段表 (Segment Table)**：存储段号到物理内存起始地址的映射关系。

### **4. 段页式虚拟存储器的基本原理**
*   **原理**：结合了段式和页式存储管理的优点。先分段，再对每个段进行分页。
*   **地址结构**：`虚拟地址 = | 段号 | 页号 | 页内偏移 |`
*   **地址转换**：先查段表，再查页表，最后得到物理地址。

---