---
科目:
课程名称:
tags: []
一轮复习情况: 进行中
二轮复习情况: 未开始
三轮复习情况: 未开始
难度:
考频:
备注:
---

# 04 文件管理
#OS #文件管理
## 04-1 文件系统基础

### 1. 文件系统基础
文件管理是操作系统中非常重要且相对复杂的一部分。你可以把文件系统想象成一个巨大的、有条不紊的"图书馆"，操作系统就是这里的"图书馆管理员"，负责管理所有的"书"（文件）和"书架"（目录）。
* **文件（File）**：
    * 在用户看来，文件就是一组有意义的信息或数据集合。在用户进行输入输出时，以文件为基本单位。
    * 最熟悉的例子就是 Windows 操作系统中的各种文件，比如 `.txt`、`.doc`、`.jpg` 等。
* **文件属性（File Attributes）**：每个文件都有一些元数据来描述它。OS通过文件控制块来维护文件元数据。
    * `文件名`：用户用来识别文件的名称，同一目录下不允许重名。
    * `标识符`：系统内部用于唯一区分文件的名称，对用户不可读。
    * `类型`：文件种类（文本文件、可执行文件、目录文件等）。
    * `位置`：文件存放的路径（用户使用）和在外存中的物理地址（操作系统使用）。
    * `大小`：文件所占存储空间的大小。
    * `创建时间、上次修改时间`：文件的生命周期信息。
    * `文件所有者信息`：记录谁拥有这个文件。
    * `保护信息`：访问控制权限等。

#### 文件内部数据的组织方式
文件内部的数据如何组织，可以分为两种主要的逻辑结构：
1. **无结构文件（流式文件）**：
    * 由一系列二进制流或字符流组成，没有明显的内部结构。
    * `示例`：`.txt` 文本文件。用户看到的只是连续的字符流。
    * `特点`：这种文件不需要深入探讨其"逻辑结构"问题。
2. **有结构文件（记录式文件）**：
    * 由一组相似的**记录**（Record）组成，每条记录又由若干个**数据项**（Data Item）组成。数据项是文件系统中最基本的数据单位。
    * `示例`：数据库表文件。
    * `记录结构`：
        * **定长记录（Fixed-Length Record）**：每条记录的长度都相同，数据项的位置和长度固定。方便快速定位。
        * **可变长记录（Variable-Length Record）**：记录长度不确定，数据项长度可能也不同。

#### 文件之间如何组织？
* 文件之间通过**目录（Directory）** 进行组织。目录就是我们常说的"文件夹"。
* 用户可以创建多层目录，形成一个有层次的结构，使文件得以合理有序地组织起来。
* `本质`：目录本身也是一种特殊且有结构的文件，它由一条条记录（即**目录项**）组成。

#### 文件如何存放在外存（磁盘）上？
* **外存（磁盘）的组织**：
    * 类似内存分为"内存块"，外存被分为一个个大小相等的 **"块/磁盘块/物理块"**。
    * 通常，一个磁盘块大小是2的整数幂（如1KB），是内存与磁盘数据交换的基本单位。
* **文件的逻辑地址**：
    * 文件在逻辑上也被分为一个个 **"文件块"**。
    * 用户看到的逻辑地址可以表示为 `(逻辑块号, 块内地址)`。
    * 操作系统需要将逻辑地址转换为 `(物理块号, 块内地址)`。

> [!NOTE] 考点总结
> *   文件属性、文件操作（系统调用）是常考选择题。
> *   `open/close` 系统调用中涉及的**打开文件表结构、计数器作用**是重点。
> *   **逻辑结构与物理结构**是文件管理的核心概念。

### 2. 文件控制块和索引节点
#### 文件控制块（FCB）
* **概念**：`FCB` 是操作系统为管理文件而设立的一种数据结构，包含文件的所有描述信息。一个FCB就是一个**文件目录项**。
* **构成**：`FCB` 的有序集合组成了**文件目录（File Directory）**。
    * 文件目录本身也是一种有结构文件，由一条条 `FCB` 记录组成。
* **主要信息**：
    * `基本信息`：文件名、物理地址、文件的逻辑结构、文件的物理结构等。
    * `存取控制信息`：访问权限（可读/可写/可执行）、禁止访问的用户名单等。
    * `使用信息`：文件建立时间、修改时间、上次访问时间等。
* **作用**：
    * **按名存取**：`FCB` 实现了文件名和文件之间的映射，使得用户可以通过文件名来访问文件。
    * **目录操作**：搜索、创建、删除、显示、修改目录项（如重命名文件）。

#### 索引结点（Inode，FCB的改进）
*   **问题**：
    *   `大小`：传统的 FCB 包含了文件的所有信息，通常会比较大（例如，一个 FCB 可能是 64B）。
    *   `效率低下`：当文件目录很大时，一个磁盘块（例如 1KB）只能存放有限的 FCB 数量（比如 1KB/64B = 16 个 FCB）。这意味着，查找一个文件时，操作系统需要频繁地将存放目录的磁盘块从磁盘调入内存进行比较，产生大量的磁盘 I/O，严重影响效率。这就像你在一个超级大的仓库里找东西，每个货架上只放了16个货品信息，你得翻很多很多货架才能找到。

**命题追踪：索引节点与文件容量的关系（2018、2020 统考真题考点）**
*   **优化思路**：
    *   我们发现，在检索目录的过程中，其实只用到了**文件名**来匹配。只有文件名匹配后，才需要去获取其他的文件描述信息。
    *   既然如此，为什么不把那些暂时用不到的信息"藏起来"，让目录项变得更小巧呢？
*   **核心概念**：
    *   **索引结点（Inode）**：为了解决 FCB 过大的问题，系统（如 UNIX）将文件**描述信息**（除了文件名之外的所有元数据，如文件类型、权限、大小、物理地址等）单独抽取出来形成一个数据结构，称为**索引结点 (Inode)**。它专门负责存储文件的元数据和数据块的地址索引，管理文件的存储位置和属性信息。
*   **目录项"瘦身"**：仅包含两部分：
    *   `文件名 (File Name)`：用于在目录中查找匹配的文件。
    *   `索引结点号 (Inode Number)` 或 `索引结点指针 (Inode Pointer)`：一个指向文件对应索引结点的唯一编号或地址。
*   **索引结点的分类**：
    1.  **磁盘索引结点（Disk Inode）**：
        *   `存放位置`：存储在外存（通常是磁盘文件系统的一个特定区域，称为 **i-list** 或索引结点区）。
        *   `主要内容`：它包含了文件的所有永久性信息，除了文件名和索引结点号之外：
            *   **文件类型**：指明是普通文件、目录文件还是特殊文件等。
            *   **文件存取权限**：定义了不同用户（所有者、组、其他）对该文件的读、写、执行权限。
            *   **文件主标识符**：拥有该文件的个人或小组的用户ID。
            *   **文件物理地址（地址索引）**：这是 Inode 的核心！每个索引结点中含有若干个**地址项 (iaddr)**，它们以直接或间接方式给出数据文件所在盘块的编号。
                *   `直接地址索引 (Direct Block Pointer)`：直接指向数据块的物理地址。这种方式能提供对文件前几个数据块的快速访问。
                *   `间接地址索引 (Indirect Block Pointer)`：指向一个**索引块**的地址。这个索引块并不存放文件数据，而是存放了更多数据块的物理地址。这样可以扩展文件寻址能力，支持大文件存储。
                *   `混合索引结构`：常见的做法是结合直接索引和多级间接索引的方式。例如，UNIX 系统常用 10 个直接地址、一个一级间接地址、一个二级间接地址、一个三级间接地址，共 13 个地址项（`iaddr(0) ~ iaddr(12)`）。这种设计平衡了小文件访问效率（直接访问）和大文件容量需求（多级间接）。
            *   **文件长度**：以字节为单位的文件实际长度。（影响文件长度的有：地址项数量、索引级数、块大小）
            *   **文件链接计数**：记录了本文件系统中所有指向该文件的**文件名指针**的数量。这是实现**硬链接**（多个文件名指向同一个文件数据）的基础。
            *   **文件存取时间**：记录了文件最近被进程存取、修改的时间以及索引结点最近被修改的时间。
    2.  **内存索引结点（Memory Inode）**：
        *   `存放位置`：当文件被打开（即需要访问其内容或属性）时，其对应的磁盘索引结点会被复制到内存中的一个数据结构，形成内存索引结点。
        *   `内容`：除了包含磁盘索引结点中的所有信息外，还会增加一些操作系统进行动态管理所需的信息：
            *   **索引结点号**：用于在内存中唯一标识这个索引结点。
            *   **状态**：指示 i 节点当前是否被锁定（防止并发修改）或是否被修改过。
            *   **访问计数 (打开计数器)**：记录当前有多少个进程正在访问或打开此 i 节点。每当一个进程打开文件，计数加 1；关闭文件，计数减 1。
            *   **逻辑设备号**：标识文件所属文件系统的逻辑设备号。
            *   **链接指针**：设置分别指向空闲链表和散列队列的指针，便于系统内部管理。

> [!NOTE] 考点总结
> *   `FCB` 和 `索引结点` 的概念及其作用是基础。
> *   理解索引结点如何优化 `FCB`，提高文件检索效率。

### 3. 文件的操作
为了方便用户和应用程序使用文件，操作系统需要提供一系列**系统调用（System Call）**：
* `创建文件（Create）`：
    * **参数**：所需外存空间大小、文件存放路径、文件名。
    * **OS处理**：
        1. 在外存中找到所需空间（利用空闲链表、位示图等）。
        2. 在对应的目录中创建该文件的**目录项（Directory Entry）**，包含文件名、存放位置等。
* `删除文件（Delete）`：
    * **参数**：文件存放路径、文件名。
    * **OS处理**：
        1. 找到对应目录项。
        2. 回收文件占用的磁盘块（更新空闲空间管理信息）。
        3. 从目录中删除目录项。
* `打开文件（Open）`：
    * **参数**：文件存放路径、文件名、操作类型（读 `r` / 读写 `rw` 等）。
    * **OS处理**：
        1. 根据路径找到目录项，并检查用户权限。
        2. 将目录项复制到内存中的**"打开文件表"（Open File Table）**中，并返回一个编号（也称**文件描述符**）。
        * **目的**：加快后续文件访问速度，避免每次操作都重新查找目录。
        * **系统打开文件表**：全系统只有一张，记录了文件在内存中的读写指针、访问权限、打开计数器等信息。
        * **用户进程打开文件表**：每个进程一张，记录该进程打开的文件的编号（文件描述符）和对系统打开文件表的索引。
* `关闭文件（Close）`：
    * **OS处理**：
        1. 删除进程打开文件表中的对应表项。
        2. 回收分配给该文件的内存资源。
        3. 系统打开文件表的 `打开计数器` 减1，若减为0，则删除系统打开文件表中的对应表项。
* `读文件（Read）`：
    * **参数**：文件描述符、要读取的数据量、数据存入内存的位置。
    * **OS处理**：从文件读指针指向的外存中，将指定大小的数据读入内存。
* `写文件（Write）`：
    * **参数**：文件描述符、要写入的数据量、内存中数据的位置。
    * **OS处理**：将内存中指定大小的数据写回写指针指向的外存。
* `文件重命名`（Rename）等更复杂的操作。

> [!NOTE] 核心要点在于理解：
> *   `Create`、`Delete`、`Open`、`Close`、`Read`、`Write` 等系统调用的**作用**和**操作系统在背后做了什么**。
> *   `Open` 和 `Close` 操作中**打开文件表**（系统级和进程级）的作用和工作原理，以及**文件描述符**的概念。

### 4. 文件的逻辑结构
"逻辑结构"指在用户看来，文件内部数据如何组织。它与"物理结构"相对。
#### 逻辑结构分类
1. **无结构文件（流式文件）**：
    * `特点`：文件内部数据是一系列二进制流或字符流，没有明显的内部结构。
    * `示例`：`.txt` 文件。用户访问时，就像读取一个连续的字节序列。
    * `访问`：用户用**逻辑地址**访问文件（如C语言 `fseek` 定位到第 `n` 个字符）。操作系统负责将逻辑地址转换为物理地址。
2. **有结构文件（记录式文件）**：
    * 由一组相似的记录组成，每条记录由若干数据项组成。
    * **定长记录**：每条记录长度相同。
    * **可变长记录**：记录长度可变。

#### 有结构文件的逻辑组织方式
根据记录在逻辑上如何组织，有结构文件可分为以下三类：
##### (1) 顺序文件（Sequential File）
* **概念**：文件中的记录一个接一个地顺序排列（逻辑上）。记录可以是定长的或可变长的。
* **物理存储**：
    * `顺序存储`：逻辑上相邻的记录在物理上也相邻（类似于顺序表）。
    * `链式存储`：逻辑上相邻的记录在物理上不一定相邻（类似于链表）。
* **随机存取**：
    * **定长记录的顺序文件 + 物理顺序存储**：可以实现**随机存取（Random Access）**。
        * `原理`：已知文件起始地址、记录长度 `L`，要找第 `i` 条记录，其地址为 `起始地址 + i * L`。
        * `计算`：若文件每块1KB，定长记录16B，则每块有64个记录。第 `i` 条记录的逻辑地址为 `(逻辑块号 m = i / 64, 块内地址 n = (i % 64) * 16)`。
    * **可变长记录的顺序文件**：只能从头开始顺序查找，**不支持随机存取**。
* **优缺点**：
    * `优点`：顺序读写速度快（如果物理上也是顺序存储）。
    * `缺点`：增加/删除记录比较困难（需要移动大量数据）。

##### (2) 索引文件（Indexed File）
* **问题**：可变长记录的顺序文件不支持随机存取，但实际应用中常需要。
* **概念**：为文件建立一张**索引表（Index Table）**，每条记录对应一个索引项。索引项通常包含 `关键字` 和 `指向记录的指针（逻辑地址）`。
    * `索引表特点`：索引表本身是定长记录的顺序文件，可以快速找到第 `i` 个记录对应的索引项。
    * `物理存储`：文件中的记录在物理上可以离散存放。
* **优点**：
    * **加快检索速度**：通过索引表可以快速定位到目标记录，支持随机存取。
    * 可以用不同的数据项建立多个索引表（如按学号、按姓名）。
* **缺点**：
    * **空间开销大**：每个记录对应一个索引项，索引表可能比文件内容本身大很多。
    * 增加/删除记录时，需要修改索引表。

##### (3) 索引顺序文件（Indexed Sequential File）
* **问题**：索引文件空间开销大的问题。
* **概念**：结合了索引文件和顺序文件的思想，但不是每个记录一个索引项，而是一**组记录（一个顺序文件分组）** 对应一个索引表项。
    * `索引表项内容`：通常包含该组的**第一个记录的关键字**和**指向该组的地址**。
    * `分组内`：每个分组本身是一个顺序文件，记录可以不按关键字排序。
* **检索效率**：显著提高检索效率。
    * `示例`：N个记录的文件，分为 `√N` 组，每组 `√N` 个记录。检索时先在索引表中顺序查找分组（`√N / 2` 次），再在分组内顺序查找记录（`√N / 2` 次），总查找次数为 `√N` 级别。
* **多级索引顺序文件**：
    * 为进一步提高效率，可以为索引顺序文件建立多级索引表（类似于内存管理中的多级页表）。
    * `示例`：对于 `10^6` 个记录的文件，建立两级索引，每级100个记录为一组，平均查找次数从 `1000` 次降至 `150` 次。
    * `计算`：为 `N` 个记录的文件建立 `K` 级索引，最优分组是每组 `N^(1/(K+1))` 个记录。平均查找次数是 `(N^(1/(K+1)) / 2) * (K+1)`。
* **优缺点**：
    * `优点`：兼顾了索引文件的高效检索和顺序文件的存储效率，特别适合大型文件。
    * `缺点`：维护索引结构需要额外开销。

> [!NOTE] 考点总结
> *   `无结构文件` 与 `有结构文件` 的概念区分。
> *   `顺序文件`、`索引文件`、`索引顺序文件` 的原理、优缺点及适用场景。
> *   **随机存取**的定义和判断（定长记录的顺序文件可随机存取，可变长记录的不行）。
> *   **多级索引顺序文件**的检索效率计算是常考计算题。

### 5. 文件的物理结构（文件分配方式）
"物理结构"指在操作系统看来，文件的数据如何在**外存（磁盘）**中存放，也就是文件的**分配方式**。
#### 磁盘块与文件块
* `磁盘块/物理块`：磁盘上存储数据的最小物理单位，大小相等（如1KB），是磁盘I/O的基本单位。
* `文件块/逻辑块`：文件在逻辑上被分为一个个块。
* `逻辑地址`：`(逻辑块号, 块内地址)`。操作系统负责将其转换为 `(物理块号, 块内地址)`。
#### 文件的三种分配方式
![[考研学习笔记03-操作系统 04 文件管理 2025-10-10 0133.png]]
##### (1) 连续分配（Contiguous Allocation）
* **概念**：每个文件在磁盘上占据一组**连续**的磁盘块。
* **目录项记录**：`文件名`、`起始块号`、`文件长度（总共占用的块数）`。
* **逻辑地址到物理地址转换**：
    * `物理块号 = 起始块号 + 逻辑块号`。
    * `特点`：可以直接计算出物理块号。
* **优缺点**：
    * `优点`：
        * 支持**顺序访问**和**直接访问（随机访问）**。
        * 顺序读写时速度最快（磁头移动距离最短）。
    * `缺点`：
        * **不方便文件拓展**：若文件需要增加块，后面没有连续空闲块则需要进行文件迁移，开销大。
        * **存储空间利用率低**：易产生**外部碎片**。
        * `处理碎片`：可以通过**紧凑（Compaction）**来处理，但耗费时间代价大。

##### (2) 链接分配（Linked Allocation）
* **概念**：文件数据可以离散地存储在磁盘块中，通过指针将这些块链接起来。分为隐式链接和显式链接。
* `优点`：
    * **方便文件拓展**：可以随便找一个空闲块挂到链尾。
    * **没有外部碎片问题**：外存利用率高。
###### ① 隐式链接（Implicit Linking）
* **概念**：除了文件的最后一个磁盘块之外，每个磁盘块中都保存指向下一个磁盘块的指针。
* **目录项记录**：`文件名`、`起始块号`、`结束块号`（也可有文件长度）。
* **逻辑地址到物理地址转换**：
    * 用户要访问逻辑块 `i`，需从起始块号开始，依次读取 `i+1` 次磁盘I/O才能找到。
* **优缺点**：
    * `优点`：方便拓展，无碎片。
    * `缺点`：
        * 只支持**顺序访问**，**不支持随机访问**。
        * 查找效率低（需要多次磁盘I/O）。
        * 指针需要占用少量存储空间。
    * `考点默认`：题目中未指明隐式/显式时，默认指的是隐式链接。
###### ② 显式链接（Explicit Linking）
* **概念**：将用于链接文件各物理块的指针**显式**地存放在一张专门的表——**文件分配表（FAT，File Allocation Table）**中。
* **FAT特点**：
    * **一个磁盘**只设置一张FAT。
    * 开机时将FAT读入内存并**常驻内存**。
    * FAT的各个表项物理上连续存储，每个表项长度相同（"物理块号"字段可隐含）。
* **目录项记录**：`文件名`、`起始块号`。
* **逻辑地址到物理地址转换**：
    * 用户要访问逻辑块 `i`，从目录项找到起始块号，然后查询内存中的FAT，直接找到 `i` 号逻辑块对应的物理块号。
    * `特点`：块号转换过程**不需要读磁盘操作**。
* **优缺点**：
    * `优点`：
        * 方便拓展，无碎片，外存利用率高。
        * 支持**顺序访问**，也支持**随机访问**（因为FAT在内存中）。
        * 访问效率比隐式链接高很多（地址转换不需访问磁盘）。
    * `缺点`：FAT需要占用一定的内存空间。

##### (3) 索引分配（Indexed Allocation）
* **概念**：文件可以离散地分配在各个磁盘块中。系统为每个文件建立一张**索引表（Index Table）**，记录了文件各个逻辑块对应的物理块。
    * `索引表功能`：类似于内存管理中的页表，建立逻辑块号到物理块号的映射关系。
    * `索引块`：存放索引表的磁盘块。
    * `数据块`：存放文件数据的磁盘块。
* **目录项记录**：`文件名`、`索引块号`（指向该文件的索引表存放的磁盘块）。
* **逻辑地址到物理地址转换**：
    * 用户访问逻辑块 `i`，根据目录项找到索引块号。
    * 将索引块从外存读入内存。
    * 查找内存中的索引表，找到 `i` 号逻辑块对应的物理块号。
* **优缺点**：
    * `优点`：
        * 支持**随机访问**。
        * 易于文件拓展。
        * 没有外部碎片，外存利用率高。
    * `缺点`：
        * 索引表需要占用一定的存储空间。
        * 访问数据块前需要先读取索引块（至少一次磁盘I/O）。
###### 大文件索引表的处理方式
当文件很大，索引表项太多，一个索引块无法装下整个索引表时，有三种解决方案：
* **① 链接方案（Linked Scheme）**：
    * `原理`：将多个索引块链接起来存放。
    * `缺点`：若文件很大，索引表很长，查找索引块时需要顺序读入多个索引块，磁盘I/O次数过多，效率低下。
* **② 多层索引（Multilevel Indexing）**：
    * `原理`：建立多层索引，类似于多级页表。一级索引块指向二级索引块，二级索引块指向数据块。
    * `最大文件长度计算`：若每个磁盘块能存放 `N` 个索引项，采用 `K` 层索引，则最大文件长度为 `N^K * 磁盘块大小`。
    * `访问数据块磁盘I/O次数`：若顶级索引表未调入内存，访问一个数据块需要 `K + 1` 次磁盘I/O。
    * `缺点`：即使是小文件，访问数据块也需要 `K + 1` 次读磁盘。
* **③ 混合索引（Hybrid Indexing）**：
    * `原理`：结合多种索引分配方式。顶级索引表中既包含**直接地址索引**（直接指向数据块），又包含**一级间接索引**（指向单层索引表），还包含**二级间接索引**（指向两层索引表）。
    * `优点`：对于小文件，访问一个数据块所需的读磁盘次数更少。对于大文件，也能有效管理。
    * `计算`：需要能根据混合索引结构计算文件的最大长度，并分析访问某个数据块所需的读磁盘次数。
        * `Key`：`FCB` 中存有指向顶级索引块的指针；每次读入下一级索引块都需要一次读磁盘操作；注意题目条件"顶级索引块是否已调入内存"。

> [!NOTE] 考点总结（超级重要！）
> *   连续、链接（隐式/显式）、索引分配方式的**原理、优缺点、适用场景**。
> *   **逻辑地址到物理地址的转换过程**。
> *   **是否支持随机访问**的判断。
> *   **多层索引**和**混合索引**的**最大文件长度计算**。
> *   **访问数据块所需的磁盘I/O次数计算**（这是计算题高频考点！）。
> *   要会画图分析各种分配方式。

### 6. 文件保护
文件保护是为了保证文件数据的安全，避免未经授权的访问和修改。
#### 保护方式
1. **口令保护（Password Protection）**：
    * `原理`：为文件设置口令，用户访问时需提供。口令通常存放在文件的 `FCB` 或索引结点中。
    * `优点`：空间开销小，验证时间开销小。
    * `缺点`：口令存放在系统内部，不够安全。
2. **加密保护（Encryption Protection）**：
    * `原理`：使用密码对文件数据进行加密，访问时需提供正确密码解密。
    * `优点`：保密性强，系统内部无需存储密码。
    * `缺点`：加密/解密需要花费时间。
3. **访问控制（Access Control）**：
    * `原理`：在每个文件的 `FCB`(文件控制块)（或索引结点）中增加一个**访问控制列表（ACL，Access-Control List）**，记录了各个用户可以对该文件执行哪些操作（读、写、执行、添加、删除等）。
    * `精简访问列表`：以"组"为单位进行权限控制（如系统管理员、文件主、文件主伙伴、其他用户），当用户访问时，检查其所属分组的权限。
    * `Windows示例`：通过图形界面设置文件和目录的访问权限。

> [!NOTE] 考点总结
> *   三种文件保护方式的**原理、优缺点**。
> *   `访问控制列表` 的概念和作用。
> *   理解目录权限控制也会影响其下所有文件。

---

## 04-2 目录

### 1. 目录的基本概念
* **概念**：目录是用于组织和管理文件的一种特殊文件，我们通常称之为"文件夹"。
* **作用**：
    * **文件组织**：将文件合理有序地组织起来，形成层次结构。
    * **按名存取**：用户通过文件名（或文件路径）来访问文件。
* **目录项**：目录由一系列**目录项**（每个目录项对应一个文件或子目录的 `FCB` 或 `文件名+索引结点指针`）组成。

### 2. 目录的操作

目录作为一种特殊文件，也需要进行相应的操作：

* `搜索（Search）`：根据文件名查找对应的目录项。
* `创建文件（Create File）`：在目录中增加一个目录项。
* `删除文件（Delete File）`：在目录中删除相应的目录项。
* `显示目录（Display Directory）`：显示目录中的所有文件及属性。
* `修改目录（Modify Directory）`：修改目录项中保存的文件属性（如文件重命名）。

### 3. 目录的结构

#### (1) 单级目录结构（Single-Level Directory）

* **概念**：整个系统中只有一张目录表，所有文件都在这一个目录下。
* **优缺点**：
    * `优点`：简单，实现了"按名存取"。
    * `缺点`：
        * **不允许文件重名**。
        * 不适用于多用户系统。
        * 文件查找效率低（文件多时）。

#### (2) 两级目录结构（Two-Level Directory）

* **概念**：分为**主文件目录（MFD，Master File Directory）**和**用户文件目录（UFD，User File Directory）**。
    * `MFD`：记录用户名及相应用户文件目录的存放位置。
    * `UFD`：由该用户的所有文件 `FCB` 组成。
* **优缺点**：
    * `优点`：
        * 允许不同用户的文件重名。
        * 可在目录上实现访问限制（检查用户名）。
    * `缺点`：缺乏灵活性，用户不能对自己的文件进行分类。

#### (3) 多级目录结构 / 树形目录结构（Tree-Structured Directory）

* **概念**：从根目录出发，形成一个树形结构，用户可以创建多层子目录。
    * `文件路径名`：用 `/` 隔开的字符串，标识文件位置。
    * `绝对路径`：从根目录开始的路径（如 `/照片/2015-08/自拍.jpg`）。
* **访问文件**：
    * **绝对路径**：每次都从根目录开始查找，逐级读入目录表。效率较低（多次磁盘I/O）。
    * **当前目录（Current Directory）与相对路径（Relative Path）**：
        * `当前目录`：操作系统维护一个当前工作目录。
        * `相对路径`：从当前目录出发的路径（如 `./2015-08/自拍.jpg`，`.` 表示当前目录）。
        * `优点`：减少磁盘I/O次数，提高访问效率。
* **优缺点**：
    * `优点`：方便文件分类，层次结构清晰，便于管理和保护。
    * `缺点`：不便于实现文件共享。

#### (4) 无环图目录结构（Acyclic-Graph Directory）

* **概念**：在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个有向无环图。
* **文件共享**：可以实现多个用户间的**文件共享**。
    * 可以用不同的文件名指向同一个文件，甚至指向同一个目录。
    * **共享计数器**：每个共享结点设置一个计数器，记录共享该结点的次数。当用户删除文件时，只删除其目录项，并使计数器减1。只有计数器减为0时才真正删除结点。
* **与复制文件区别**：
    * `共享文件`：多个用户指向同一个文件数据，修改可见。
    * `复制文件`：系统中有多份独立的文件数据，修改互不影响。
* **与"硬链接"、"软链接"的关系**：
    * **硬链接（Hard Link）**：基于索引结点的共享方式。多个目录项指向同一个索引结点，索引结点的**链接计数器（Count）**记录硬链接数。删除硬链接只是 `Count-1`，只有 `Count=0` 时才删除文件数据。
    * **软链接/符号链接（Soft Link/Symbolic Link）**：基于符号链的共享方式。创建一个特殊文件（`Link` 类型），该文件内容记录了被链接文件的**存放路径**。
        * `优点`：可以跨文件系统链接，也可以链接目录。
        * `缺点`：当原文件被删除时，软链接会"悬空"，指向一个不存在的文件。需要额外I/O查找路径。

> [!NOTE] 考点总结
> *   `单级`、`两级`、`多级/树形`、`无环图` 目录结构的**原理、优缺点、适用场景**。
> *   `绝对路径` 和 `相对路径` 的概念，以及`当前目录`如何减少磁盘I/O。
> *   `无环图目录结构` 解决文件共享的原理，以及**硬链接与软链接**的区别、优缺点。
> *   `共享计数器` 的作用。

### 4. 目录实现

* 本节在"04-1 文件系统基础"和"04-2 目录-2.目录结构"中已经涉及。
* **目录实现的核心**就是通过 `FCB` 或 `索引结点` 来组织目录项，并根据目录结构（单级、两级、多级、无环图）来管理这些目录项。
* `目录本身是一种特殊的文件`：它的内容就是其下文件或子目录的目录项。

### 5. 文件共享
#### 1. **索引节点（Inode - Index Node）**
*   **定义**：在许多类Unix文件系统中，Inode是一个**数据结构，存储文件（或目录）的元数据（metadata）**，包括文件类型、权限、属主、组、时间戳、文件大小，以及指向文件实际数据块的指针。
*   **特性**：**每个文件（或目录）在文件系统内都有一个唯一的Inode**。文件名只是指向Inode的"别名"或"入口"。
*   **重要性**：**Inode中包含文件的引用计数**。

#### 2. **引用计数（Reference Count / Link Count）**
*   **定义**：存储在文件的**Inode**中，表示**有多少个文件名（或硬链接）指向这个Inode**。
*   **机制**：
    *   每当创建一个指向该Inode的硬链接，引用计数**加 1**。
    *   每当删除一个指向该Inode的文件名或硬链接，引用计数**减 1**。
    *   只有当引用计数降到 **0** 时，文件系统才会认为这个Inode及其关联的数据块不再被使用，从而将其**真正删除并释放存储空间**。
*   **目的**：实现文件共享和安全删除。

#### 3. **文件链接（File Link）**
*   **定义**：一种允许在文件系统中**创建指向现有文件或目录的额外入口**的机制，而无需复制文件内容。

#### 4. **符号链接 / 软链接（Symbolic Link / Soft Link / Symlink）**
*   **定义**：一种特殊的文件，它的**内容是它所指向的目标文件（或目录）的路径字符串**。
*   **特性**：
    *   **独立文件**：软链接本身是一个独立的文件，拥有自己的Inode和数据块。
    *   **引用计数**：**不增加目标文件的引用计数**。
    *   **跨文件系统**：可以链接到不同文件系统中的文件。
    *   **悬空（Dangling）**：如果目标文件被删除，软链接会变成"悬空链接"，指向一个不存在的路径。
    *   **类比**：Windows系统中的"快捷方式"。

#### 5. **硬链接（Hard Link）**
*   **定义**：一个文件名，它**直接指向文件系统中的同一个Inode**，与原始文件名享有同等地位。可以理解为给同一个Inode起了多个名字。
*   **特性**：
    *   **非独立文件**：硬链接不是一个独立的文件，它**没有自己的Inode和数据块**，而是直接使用目标文件的Inode。
    *   **引用计数**：每创建一个硬链接，目标文件的Inode中的**引用计数加 1**。
    *   **同文件系统**：只能在同一个文件系统内创建。
    *   **健壮性**：只要至少有一个硬链接存在，文件数据就不会被删除。即使原始文件名被删除，通过其他硬链接仍可访问文件内容。
    *   **限制**：通常不能对目录创建硬链接（以避免循环引用），也不能跨文件系统。

> [!NOTE] 考点总结
> *   理解"共享文件"与"复制文件"的本质区别。
> *   掌握**硬链接**（通过索引结点计数器）和**软链接**（通过存储路径）的实现机制。
> *   能够分析两种链接方式的优缺点，特别是软链接可能产生"悬空指针"的问题。

---

## 04-3 文件系统

### 1. 文件系统结构（层次结构）

文件系统并非一个简单的整体，而是由多个层次或模块组成的复杂系统。不同的教材可能会有不同的分层方法，但核心思想是**模块化**和**抽象**。

#### 文件系统的层次结构（一种常见划分）

1. **用户接口层（User Interface）**：
    * `功能`：向用户和应用程序提供统一、标准的系统调用接口（`Open`、`Read`、`Write`、`Close` 等）。屏蔽底层具体文件系统的实现差异。
    * `示例`：用户发出删除文件请求。
2. **文件目录系统（File Directory System）**：
    * `功能`：根据用户提供的文件路径（名）查找对应的 `FCB` 或索引结点。管理活跃文件目录表、打开文件表等所有与目录和目录项相关的管理工作。
    * `示例`：根据文件路径找到对应目录项。
3. **存取控制模块（Access Control Module / Access-Control Verification Layer）**：
    * `功能`：验证用户是否有访问文件的权限，以保证文件数据安全。
    * `示例`：检查用户是否具备删除文件的权限。
4. **逻辑文件系统与文件信息缓冲区（Logical File System & File Information Buffer）**：
    * `功能`：将用户指定的逻辑记录号转换为对应的**逻辑地址**（逻辑块号，块内地址）。管理文件信息缓冲区。
    * `示例`：将删除第 `X` 条记录的请求转换为对应的逻辑块号和块内偏移量。
5. **物理文件系统（Physical File System）**：
    * `功能`：负责将逻辑地址（逻辑块号，块内地址）转换为实际的**物理地址**（物理块号，块内地址）。这一层与文件分配方式（连续、链接、索引）密切相关。
    * `示例`：根据逻辑块号和文件分配方式，计算出实际的物理块号。
6. **辅助分配模块（Auxiliary Allocation Module）**：
    * `功能`：负责文件存储空间的管理，即分配和回收磁盘块。
    * `示例`：删除记录后，回收空闲盘块。
7. **设备管理模块（Device Management Module）**：
    * `功能`：直接与硬件交互，负责设备分配、设备缓冲区管理、磁盘调度、启动/释放设备等硬件相关管理工作。
    * `示例`：向磁盘设备发出删除记录的请求。

> [!NOTE] 考点总结
> *   理解文件系统层次结构的**分层思想**和**每一层的功能**。
> *   能够通过一个文件操作的例子（如删除文件记录）来串联各个层次的功能。
> *   注意不同教材的分层可能略有差异，理解核心功能即可。

### 2. 文件系统布局（全局结构）

文件系统在磁盘上和内存中都有其对应的结构。

#### 文件系统在外存中的结构（磁盘布局）

* **原始磁盘（Raw Disk）**：物理格式化前。
* **物理格式化（Physical Formatting / Low-Level Formatting）**：
    * `目的`：将磁盘划分为扇区，检测坏扇区并进行替换。
    * `结果`：形成扇区。
* **磁盘分区（Partitioning / Volume）**：
    * `目的`：将物理磁盘划分为多个独立的文件卷（逻辑卷，如C:盘、D:盘）。
* **逻辑格式化（Logical Formatting）**：
    * `目的`：在每个分区上建立文件系统，进行初始化。
    * `结果`：每个文件卷被划分为：
        * **引导块（Boot Block）**：存放操作系统引导程序。
        * **分区信息块**：记录分区自身的元数据。
        * **文件系统信息块**（如超级块）。
        * **目录区**：存放文件目录信息 (`FCB` 或索引结点) 和磁盘存储空间管理信息。
        * **文件区**：用于存放文件数据。

#### 文件系统在内存中的结构

* 操作系统在内存中维护一些数据结构，以加速文件访问和管理。
    * **内存中的文件分配表（FAT）**：显式链接分配时常驻内存。
    * **内存中的超级块（Superblock）**：成组链接法空闲管理时常驻内存。
    * **内存中的打开文件表（Open File Table）**：用于管理当前打开的文件。
    * **内存中的最近访问目录文件缓存**：加速目录检索。
    * **VFS的 vnode 等数据结构**。

> [!NOTE] 考点总结
> *   `物理格式化`、`磁盘分区`、`逻辑格式化` 的概念和作用。
> *   文件系统在**磁盘上**和**内存中**的关键数据结构。
> *   了解 `open` 系统调用背后在内存和外存数据结构上的操作过程。

### 3. 文件存储空间管理

本节主要探讨"外存中没有存放文件数据的空闲空间该如何管理"的问题。它与"文件的物理结构（文件分配方式）"相辅相成。

#### 存储空间的划分与初始化

* **划分**：将物理磁盘划分为一个个**文件卷**（逻辑盘），如C、D、E盘。
* **初始化**：将文件卷划分为**目录区**（存放目录信息、空闲空间管理信息）和**文件区**（存放文件数据）。

#### 四种空闲空间管理方法

##### (1) 空闲表法（Free-Space Table）

* **概念**：将所有空闲盘区用一张**空闲盘块表**来记录。每个表项包含 `第一个空闲盘块号` 和 `空闲盘块数`。
* **适用场景**：主要适用于**连续分配方式**。
* **分配**：类似于内存管理中的动态分区分配，采用首次适应、最佳适应、最坏适应等算法为文件分配连续的存储空间。
* **回收**：回收时需注意表项的合并问题（与内存动态分区回收类似）。

##### (2) 空闲链表法（Free-Space List）

* **概念**：将所有空闲盘块或空闲盘区用链表的形式链接起来。
    * **空闲盘块链**：每个空闲盘块中存储指向下一个空闲盘块的指针。
        * `分配`：从链头依次摘下所需数量的盘块。
        * `回收`：回收的盘块挂到链尾。
        * `适用`：离散分配（如隐式链接）。
    * **空闲盘区链**：每个空闲盘区的第一个盘块记录该盘区的长度和指向下一个盘区的指针。
        * `分配`：从链头检索，找到合适的空闲盘区进行分配，并修改链指针。
        * `回收`：回收时检查是否与相邻空闲盘区合并。
        * `适用`：连续分配和离散分配。效率更高。

##### (3) 位示图法（Bitmap）

* **概念**：使用一张**位示图**（一个二进制位对应一个盘块）来记录磁盘空间的使用情况。
    * `0` 代表盘块空闲，`1` 代表盘块已分配。
    * 位示图通常用连续的"字"来表示。
* **盘块号与 (字号, 位号) 的转换**：
    * 若盘块号 `b`、字长 `n`、字号 `i`、位号 `j` 都从0开始：
        * `(i, j)` 对应的盘块号 `b = n * i + j`
        * 盘块号 `b` 对应的字号 `i = b / n`，位号 `j = b % n`
    * （注意：如果题目中起始编号从1开始，公式会有微调）。
* **分配**：
    * 找到 `K` 个连续或不连续的 `0` 位。
    * 根据 (字号, 位号) 算出盘块号，分配给文件。
    * 将相应位设置为 `1`。
* **回收**：
    * 根据回收的盘块号算出 (字号, 位号)。
    * 将相应位设为 `0`。
* **适用场景**：连续分配和离散分配都适用。

##### (4) 成组链接法（Group Chaining）

* **概念**：UNIX 系统中采用的一种空闲块管理方法，适用于大型文件系统，解决了空闲表/链表过大的问题。
* **原理**：
    * 在文件卷的目录区中，专门有一个**超级块（Superblock）**，系统启动时读入内存并常驻。
    * 将空闲磁盘块分为若干组，每组包含 `K` 个空闲块（例如100个）。
    * `超级块`：记录第一个空闲块组的信息（组内空闲块数、下一个空闲块组的起始块号）。
    * `每个空闲块组的第一个块`：记录了该组内剩余空闲块的块号，以及下一个空闲块组的起始块号。最后一个空闲块组的起始块号通常为特殊值（如-1）。
* **分配**：
    * 请求 `X` 个空闲块。
    * 若超级块中记录的第一个分组块数足够，则分配。
    * 若第一个分组块数不足，或者刚好用完，则需要将该分组中记录的**下一组信息复制到超级块中**，然后从新的分组开始分配。
* **回收**：
    * 回收的块优先添加到当前第一个分组。
    * 若第一个分组已满，则需要将**超级块中的现有信息复制到新回收的块中**，然后让新回收的块成为新的第一个分组，并更新超级块。
* **优缺点**：
    * `优点`：高效，适用于大型文件系统，解决空闲表/链表过大的问题。
    * `缺点`：管理逻辑相对复杂。

> [!NOTE] 考点总结
> *   `空闲表法`、`空闲链表法`、`位示图法`、`成组链接法` 的**原理、分配和回收过程、适用场景**。
> *   `位示图法` 中**盘块号与 (字号, 位号) 的相互转换计算**是常考题型。
> *   `成组链接法` 的分配和回收过程（特别是涉及超级块更新的场景）是难点。

### 4. 虚拟文件系统（VFS，Virtual File System）

* **问题**：操作系统可能支持多种不同的文件系统（如FAT32、NTFS、ext4等），它们表示文件数据结构和操作方式各不相同。如何向用户提供统一的接口？
* **概念**：`VFS` 是操作系统文件系统的一个抽象层，它向上层用户进程提供统一标准的系统调用接口，同时屏蔽了底层具体文件系统的实现差异。
* **特点**：
    1. **统一接口**：向上层提供统一的 `Open/Read/Write` 等系统调用接口。
    2. **规定函数功能**：`VFS` 要求底层具体文件系统必须实现某些规定的函数功能（如 `open()`、`read()`、`write()`），才能在该操作系统上被使用。
    3. **统一内部表示**：每打开一个文件，`VFS` 就在主存中新建一个 `vnode`（虚拟节点），用统一的数据结构表示文件，无论该文件存储在哪个文件系统。
        * `vnode` 只存在于主存中。`inode` 既存在于主存也存在于外存。
    4. **功能指针**：`vnode` 中的功能指针会指向具体文件系统的函数功能实现。

> [!NOTE] 考点总结
> *   `VFS` 的**概念、作用**（统一接口、屏蔽差异）。
> *   `vnode` 的概念，以及与 `inode` 的区别。

### 5. 文件系统挂载（Mounting）

* **概念**：文件系统挂载（安装/装载）是指将一个文件系统（如一个分区、一个U盘的文件系统）连接到操作系统现有文件树的某个**挂载点（Mount Point）**（一个父目录）上的过程。
* **挂载要做的事情**：
    1. **注册**：在 `VFS` 中注册新挂载的文件系统，更新内存中的**挂载表（Mount Table）**，其中包含文件系统类型、容量等信息。
    2. **提供函数地址列表**：新挂载的文件系统要向 `VFS` 提供其实现 `open/read/write` 等操作的函数地址列表。
    3. **挂载到挂载点**：将新文件系统挂载到指定父目录下，使其内容在文件树中可见。

> [!NOTE] 考点总结
> *   `文件系统挂载` 的**概念和目的**。
> *   挂载过程中操作系统（特别是 `VFS`）需要进行的操作。

---
