---
科目:
课程名称:
tags: []
一轮复习情况: 进行中
二轮复习情况: 未开始
三轮复习情况: 未开始
难度:
考频:
备注:
---

# 中断
 #操作系统 #中断 #异常 #中断处理 #中断判优 #中断屏蔽 #中断隐指令 #中断服务程序

> [!NOTE] 学习目标
> *   理解中断的**基本概念**、作用和在计算机系统中的重要性。
> *   区分中断和异常（陷阱、故障、中止）的**异同**。
> *   掌握中断的**分类**（外部中断、内部中断、可屏蔽、非屏蔽）。
> *   理解中断请求的产生和CPU**响应中断的条件**。
> *   掌握**中断判优**的原理和实现方式（硬件排队器、软件查询）。
> *   详细理解**中断处理过程**的四个阶段：中断请求、中断响应、中断处理、中断返回。
> *   深入理解**中断隐指令**的功能和执行步骤。
> *   掌握**中断服务程序 (ISR)** 的主要任务（保护/恢复现场、中断服务）。
> *   区分**单重中断**和**多重中断 (中断嵌套)** 的区别。
> *   理解**中断屏蔽技术**的原理和应用，如何设置屏蔽字。

## 01-1 中断的基本概念与作用

### 1. 中断的定义
**程序中断 (Interrupt)** 是指计算机在执行现行程序的过程中，出现某些**急需处理的异常情况或特殊请求**（通常是来自CPU**外部**的事件），CPU暂时中止现行程序的执行，转而去对这些异常情况或特殊请求进行处理。在处理完毕后，CPU又自动返回到现行程序的**断点处**，继续执行原程序。
* **关键词**：**暂停**、**转移**、**处理**、**返回**。
* **作用**：
    * **多任务/多道程序**：让CPU可以高效地在多个任务之间切换，提高CPU利用率。
    * **实时响应**：允许CPU及时响应外部事件（如键盘输入、I/O设备完成操作）。
    * **处理异常**：对一些非预期的错误或事件进行处理。
    * **实现I/O控制**：程序中断方式是CPU与I/O设备之间进行数据交换的一种高效方式。

### 2. 中断与异常的区分
中断和异常是引起CPU暂停当前程序、转而执行特定处理程序的两类事件。它们有很多相似之处，但来源和性质不同。

| 特性     | 中断 (Interrupt)                               | 异常 (Exception)                               |
| :------- | :--------------------------------------------- | :--------------------------------------------- |
| **发生源** | **外部事件**（I/O设备、定时器、电源故障等）| **CPU内部事件**（由当前指令执行引起）|
| **同步性** | **异步的**：与CPU当前正在执行的指令无关，随时可能发生 | **同步的**：总是与某条特定的指令相关联，在该指令执行时发生 |
| **可屏蔽性** | **通常可屏蔽**：CPU可以设置是否响应某些中断请求（通过PSW的IF位）| **不可屏蔽**：一旦发生，CPU必须立即处理（如除零错误）|
| **处理后返回点** | 通常返回到**被中断指令的下一条指令**         |
|          | 往往回到**引起异常的指令处重新执行**（故障）或**该指令的下一条指令**（陷阱）|

#### (1) 异常的细分
* **故障 (Fault)**：在指令执行**前**被检测到，且可以**被修复**。修复后通常会**重新执行该指令**。
    * **示例**：缺页故障 (Page Fault)：程序访问的页面不在内存，OS将其调入后，重新执行引起缺页的访存指令。
* **陷阱 (Trap)**：在指令执行**后**被检测到，**不能被修复**。其目的是为了**切换到操作系统**执行一些服务（如系统调用）。
    * **示例**：除零错误、系统调用 (通过特殊指令如 `INT`)。
* **中止 (Abort)**：发生**严重错误**，导致程序无法恢复，通常会**终止程序**。
    * **示例**：硬件故障，如内存校验错误。

## 01-2 中断的分类与请求
### 1. 中断的分类
#### (1) 按中断源分类
1. **外部中断**：来自CPU外部的硬件设备。
    1. **I/O 设备请求**：这是最常见的外部中断。
        * **键盘输入**：用户敲击键盘时，键盘控制器会向 CPU 发送一个中断信号，通知 CPU 有新的按键数据。
        * **鼠标移动/点击**：鼠标控制器发送中断，通知 CPU 鼠标位置或按键状态改变。
        * **硬盘/SSD 完成数据传输**：当硬盘控制器完成数据读取或写入后，会发送中断通知 CPU 数据已准备好或操作已完成。
        * **网卡接收到数据包**：网卡收到网络数据后，发送中断通知 CPU。
        * **打印机完成打印**：打印机通知 CPU 打印任务完成。
    2. **时钟中断 (Clock Interrupt / Timer Interrupt)**：由系统中的定时/计数器芯片（定时器）周期性地发出中断信号。
        * 用于操作系统进行**时间片轮转**调度，实现多任务并发。
        * 用于维持系统时间、实现定时任务等。
    3. **电源故障中断**：当检测到电源即将断电时，电源管理单元会发出中断，给操作系统一个机会来保存关键数据或执行关机流程。
    4. **硬件故障中断**：如内存奇偶校验错误、风扇故障等硬件问题引起的中断。
    5. **手动中断**：例如按下复位按钮（虽然严格来说更像一个启动信号，但在某些设计中也可被视为一种强行中断）。
2. **内部中断 (也常归类到异常)**：由CPU内部事件引起。
    * **软件中断 (软中断)**：通过执行一条特殊指令（如 `INT` 指令）由软件主动触发，用于系统调用或调试。

#### (2) 按可屏蔽性分类
1. **非屏蔽中断 (Non-Maskable Interrupt, NMI)**：
    * 优先级最高，即使在关中断状态下也会被CPU响应和处理。
    * 通常用于处理**紧急且致命**的事件，如电源掉电。
2. **可屏蔽中断 (Maskable Interrupt)**：
    * 大多数中断都是可屏蔽中断。
    * CPU可以通过设置**中断允许标志 (IF)** 来决定是否响应这类中断请求。

### 2. 中断请求的产生与标记
* **中断源**：能够发出中断请求的设备或事件。
* **中断请求标记触发器 (INTR)**：每个中断源都设置一个中断请求标记触发器。当其状态为"1"时，表示中断源有中断请求。
* **中断请求标记寄存器**：这些触发器可以组成一个寄存器，集中在CPU中或分散在各个中断源中。
* **外部中断**：CPU会在统一的时刻（通常是**每条指令执行阶段结束前**）向接口发出中断查询信号，以获取I/O的中断请求。
* **IF标志位**：位于CPU的**程序状态字寄存器 (PSW) / 标志寄存器 (FLAGS)** 中。
    * `IF = 1`：表示开中断（允许响应可屏蔽中断）。
    * `IF = 0`：表示关中断（不允许响应可屏蔽中断）。
    * **关中断的作用**：实现原子操作（一段不希望被中断打断的代码）。

### 3. CPU响应中断的条件
CPU响应中断必须同时满足以下3个条件：
1. **中断源有中断请求**：对应的中断请求标记触发器为1。
2. **CPU允许中断**：CPU处于**开中断**状态 (`IF = 1`)。
3. **一条指令执行完毕**：CPU必须在完成当前指令的执行后才能响应中断，以确保程序状态的完整性，且没有更紧迫的任务（如更高级别的中断或DMA请求）。

### 4. 中断判优
当有多个中断源同时提出中断请求时，CPU需要根据一定的**优先级**来确定响应哪个中断源，这个过程称为**中断判优**。

* **实现方式**：
    1. **硬件实现**：通过**硬件排队器**实现。排队器既可以设置在CPU中，也可以分散在各个中断源中。
    2. **软件实现**：通过**查询程序**（在中断服务程序开头）来逐一判断是哪个设备发出的中断。
* **优先级设置原则**：
    1. **硬件故障中断**属于最高级，其次是**软件中断**。
    2. **非屏蔽中断**优于**可屏蔽中断**。
    3. **DMA请求**优于**I/O设备传送的中断请求**。
    4. **高速设备**优于**低速设备**。
    5. **输入设备**优于**输出设备**。
    6. **实时设备**优于**普通设备**。

## 01-3 中断处理过程：CPU的"急诊室流程"
CPU响应中断后，会进入一个标准的处理流程，通常包括以下阶段：
* **中断请求** (I/O设备发起)
* **中断响应** (CPU硬件自动完成中断隐指令)
* **中断处理** (中断服务程序，软件完成)
    1. **保护现场**：CPU 将当前正在运行程序的关键信息（如**程序计数器 PC**、**通用寄存器内容**、**程序状态字 PSW** 等）保存到栈中，以便后续恢复。
    2. **中断向量寻址**：根据中断类型（通常由中断控制器提供），确定对应的中断服务程序的入口地址。这个地址通常存储在中断向量表中。
    3. **中断服务程序 (ISR) 执行**：CPU 跳转到中断服务程序的入口地址，开始执行中断服务程序。这个程序专门用于处理特定的中断事件（例如，读取键盘缓冲区的数据，向硬盘控制器发送下一条命令等）。
    4. **恢复现场**：中断服务程序执行完毕后，CPU 从栈中恢复之前保存的程序现场信息（PC、寄存器等）。
* **中断返回** (CPU硬件自动完成中断返回指令)
### 1. 中断隐指令 (Interrupt Micro-instruction)
* **定义**：中断隐指令并不是一条具体的机器指令，而是CPU在检测到中断请求并允许响应时，由**硬件自动完成**的一系列动作。
* **主要任务**：
    1. **关中断**：将 `IF` 标志位清零，暂时禁止响应新的可屏蔽中断，以保护中断现场期间不被新的中断打断，确保中断处理的原子性。
    2. **保存断点**：将当前程序（被中断程序）的**程序计数器 (PC)** 内容（即下一条要执行的指令地址）保存起来，通常是**压入系统栈**。这是为了保证在中断服务程序执行完毕后能正确返回到原程序。
    3. **引出中断服务程序**：获取中断服务程序的入口地址，并将其送入 `PC`，使CPU跳转到中断服务程序的第一条指令开始执行。
        * **硬件向量法**：中断控制器根据中断请求直接产生一个**中断类型号**（或中断向量地址），CPU根据这个类型号查找**中断向量表**，从表中获取中断服务程序的入口地址。这是高效且常用的方式。
        * **软件查询法**：如果中断源没有提供中断类型号，CPU统一跳转到一个通用入口，由中断服务程序通过软件查询中断请求标记寄存器来判断具体的中断源。

### 2. 中断服务程序 (Interrupt Service Routine, ISR)
中断服务程序是专门用来处理特定中断事件的一段程序。它在中断隐指令将控制权转移过来后开始执行。
* **主要任务**：
    1. **保护现场**：除了中断隐指令保存的 `PC` 外，中断服务程序还需要保存**通用寄存器**和**程序状态字 (PSW)** 等CPU环境的关键内容，通常也压入栈中。这是为了确保原程序在中断返回后能够恢复到中断前的完整状态。
    2. **中断服务 (设备服务)**：这是ISR的主体部分，执行真正处理中断事件的代码。例如，对于键盘中断，读取键盘输入；对于打印机中断，将数据送入打印机缓冲。
    3. **恢复现场**：在中断服务完毕后，通过出栈指令或其他取数指令，把之前保存的通用寄存器和PSW等信息送回对应的寄存器中，恢复CPU环境。
    4. **中断返回**：执行专门的**中断返回指令**（如 `IRET` 或 `RETI`）。这条指令会从栈中弹出之前保存的 `PC` 和 `PSW`，并使 `PC` 指向原程序的断点处，同时恢复中断允许标志（开中断），使CPU返回到原程序继续执行。

### 3. 单重中断与多重中断 (中断嵌套)
* **单重中断 (Single Interrupt)**：
    * 指在执行中断服务程序期间，CPU**不响应**新的中断请求。
    * **实现**：中断隐指令在开始时**关中断**，直到中断服务程序全部执行完毕，通过中断返回指令才**开中断**。
    * **特点**：结构简单，但如果中断服务程序很长，可能导致高优先级中断长时间得不到响应。
* **多重中断 (Multiple Interrupts / Interrupt Nesting)**：
    * 又称**中断嵌套**。指在执行低优先级中断服务程序期间，CPU可以响应**更高优先级**的新中断请求。
    * **实现**：
        1. 中断隐指令在开始时**关中断**。
        2. 在中断服务程序的**保护现场阶段结束后**，**提前设置开中断指令**。这样，在该ISR执行过程中，若有更高级别的中断到来，CPU可以响应。
        3. 低优先级中断服务程序被中断后，高优先级中断服务程序执行。高优先级ISR执行完毕后，返回到被中断的低优先级ISR，继续执行。
    * **特点**：提高了系统的实时响应能力和CPU效率，但控制复杂。
    * **条件**：要具备多重中断功能，须满足：①在中断服务程序中提前设置开中断指令；②优先级别高的中断源有权中断优先级别低的中断源。

### 4. 中断屏蔽技术 (Interrupt Masking)
中断屏蔽技术主要用于**多重中断**，它允许系统灵活地调整和控制不同中断源的优先级。
* **屏蔽触发器与屏蔽字**：
    * 每个中断源都有一个**屏蔽触发器**。`1` 表示**屏蔽**（禁止）该中断源的请求，`0` 表示可以**正常申请**。
    * 所有屏蔽触发器组合在一起，便构成一个**屏蔽字寄存器**，其内容称为**屏蔽字**。
* **应用原理**：
    * 在处理某个中断源 `A` 的中断服务程序时，会将**对应中断源 `A` 的屏蔽字**加载到屏蔽字寄存器中。
    * 该屏蔽字决定了在处理 `A` 中断期间，哪些中断源可以被响应，哪些会被屏蔽。
    * **屏蔽字设置规律**：
        1. 一般用 `1` 表示屏蔽，`0` 表示正常申请。
        2. 每个中断源都对应一个屏蔽字（当CPU正在处理该中断源时，屏蔽字寄存器加载该屏蔽字）。
        3. **屏蔽字中 `1` 越多，表示中断优先级越高**。例如，如果 `A` 中断服务程序对应的屏蔽字比 `B` 中断的屏蔽字有更多的 `1`，则意味着 `A` 中断时屏蔽了更多中断，其优先级相对更高。
        4. **每个屏蔽字中至少有一个 `1`**：至少要能屏蔽**自身**的中断，以避免在处理自身中断时再次被自身中断。
* **示例**：假设中断源优先级 `A > B > C > D`。如果需要改为 `D > A > C > B`。
    * 当处理 `D` 时，优先级最高，应该屏蔽 `A, B, C`：`D` 的屏蔽字可能是 `1111`。
    * 当处理 `A` 时，优先级次高，应该屏蔽 `B, C` 但不屏蔽 `D`：`A` 的屏蔽字可能是 `0110`。
    * 以此类推，通过调整屏蔽字的位数来调整优先级。

---
