---
科目: "408"
课程名称: 计算机网络
tags: [网络层]
一轮复习情况: 进行中
二轮复习情况: 未开始
三轮复习情况: 未开始
难度:
考频:
备注:
---

# 04-网络层

## **04-1 网络层的功能**
![[考研学习笔记04-计算机网络 04-网络层 2025-10-12 0356.png|645x363]]

### **1. 异构网络互连**
*   **概念**： #异构网络互连
    *   将两个以上的计算机网络，通过一定的方法，用一种或多种通信处理设备（即**中间设备**）相互连接起来，以构成更大的网络系统。
    *   网络的**异构性**是指传输介质、数据编码方式、链路控制协议及不同的数据单元格式和转发机制等特点，这些特点分别在物理层和数据链路层协议中定义。
    *   IP网上的主机进行通信时，就好像在一个单个网络上通信一样，**看不到互联各网络具体的异构细节**（如编址方案、路由选择协议）。网络层通过IP协议屏蔽了底层异构网络的差异。
    *   互联网就是由多个异构网络互连组成的。
*   **中间设备（中继系统）**：
    *   **物理层中继系统**： #中继器 #集线器 (Hub)。它们只是简单地扩大了网络的物理范围，所有连接的设备仍然属于同一个逻辑网络。
    *   **数据链路层中继系统**： #网桥 #交换机 。它们工作在数据链路层，能够隔离冲突域，但不能隔离广播域（VLAN除外）。
    *   **网络层中继系统**：#路由器。它是实现网络互连的核心设备，能够隔离冲突域和广播域。
    *   **网络层以上的中继系统**：#网关。通常指在不同协议体系之间进行转换的设备。
    *   **注意**：使用物理层或数据链路层的中继系统时，只是把一个网络扩大了，从网络层的角度看，**仍然是同一个网络**，一般并不称为网络互联。只有路由器才能真正实现不同逻辑网络（不同IP网络）的互连。
*   **核心功能**：#网络层 最核心的功能之一就是实现不同类型的（#异构网络）（如以太网、WiFi、PPP链路等）之间的互联互通。它通过提供统一的 **#IP地址 寻址机制**，使得数据报可以在全球范围内的异构网络中传输，屏蔽了底层物理链路和数据链路层的差异。

### **2. 路由与转发**
（详见（八）网络层设备）
*   **路由（Routing）**： #路由
    *   这是 #路由器 在网络中找到一条从源主机到目的主机的**最佳路径**（通常是最短路径）的过程。
    *   路由器通过运行 #路由算法 和 #路由协议 来动态地建立和维护 **#路由表**。
    *   **路由是整个网络范围内的路径选择过程，涉及多个路由器协同工作**。它指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
*   **转发（Forwarding）**： #转发
    *   这是路由器根据其**转发表**（路由表的硬件优化版本），将收到的 #IP数据报 从合适的输出端口转发出去的过程。
    *   **转发是路由器在单个路由器内部的动作**，它根据转发表中的信息，快速地将数据包从一个输入接口送到一个输出接口。关键操作是转发表查询、转发及相关的队列管理和任务调度等。
*   **主机到主机通信**：网络层通过IP地址实现**逻辑上的跨网络数据传输**，使得不同网络中的主机能够进行端到端的通信。**其实现机制是路由器逐跳（hop-by-hop）转发。**
*   **分组转发**：路由器是网络层的核心设备，它根据IP数据报首部信息（源IP、目的IP）来决定如何转发数据。
*   **网络层协议关系**： #网络层协议关系

    ```plaintext
    应用层协议 (HTTP, FTP) → 传输层协议 (TCP/UDP) → 网络层协议 (IP) → 数据链路层协议 (以太网)
    ```

> [!NOTE] 服务层次 #网络层服务
> *   **上层服务**：网络层为传输层提供**封装IP数据报**的服务。
> *   **下层依赖**：网络层依赖数据链路层将IP数据报封装成帧进行传输。

*   **路由器补充**：
    *   路由器是第三层（网络层）设备，向传输层及以上层次隐藏下层的具体实现。
    *   路由器连接的各个网络，其物理层、数据链路层、网络层协议可以不同。
    *   网络层之上的协议数据报文是路由器所不能处理的，网络层以上的高层协议必须相同才能通信。

### **3. 网络层能够提供的两种服务**

> [!NOTE] 两种服务类型 #网络层服务类型
> 早期，网络层被设计为可以提供两种服务：
> 1.  **面向连接的虚电路服务 (Virtual-Circuit Service)**： #虚电路服务 类似电话网络，在数据传输前先建立一条逻辑连接，所有数据都沿这条虚电路传输。它在数据传输前，需要经过**"建立连接-数据传输-释放连接"**三个阶段。如果网络中某个节点或链路发生故障，虚电路会中断，需要重新建立。虚电路服务能够提供**可靠的、按序的**数据传输。
> 2.  **无连接的数据报服务 (Datagram Service)**： #数据报服务 类似邮政系统，每个数据报独立传输，不预先建立连接，每个路由器独立转发。每个数据报都带有完整的源地址和目的地址，它们可能沿着不同的路径到达目的地，因此**可能出现乱序、重复或丢失**。数据报服务是**尽力而为（Best-Effort）**的服务，不保证可靠性。
> 
> **目前互联网主要采用的是**：**无连接的数据报服务**。#IP协议 就是典型的无连接协议。
> **为什么互联网选择了无连接的数据报服务？** 因为它更灵活、更健壮、更容易实现和扩展。即使网络中某些节点发生故障，数据报也可以通过其他路径绕道而行，而不需要重新建立整个通信路径，大大提高了网络的**适应性和容错性**。传输层（如TCP）负责在上层提供可靠性。

### **4. 软件定义网络SDN**

> [!NOTE] #SDN #软件定义网络
> SDN 是一种支持动态、弹性管理的新型网络体系结构，是实现高带宽、动态网络的理想架构。

*   **概念**：SDN的核心思想是将网络的**控制平面（大脑）**与**数据平面（身体）**分离。控制平面由软件集中控制，负责网络的路由决策和策略管理；数据平面只负责数据转发。
    *   **传统网络**：每个路由器既有转发表又有路由选择软件，既有数据层面也有控制层面。
    *   **SDN**：控制层面利用控制-数据接口对数据层面上的路由器进行集中式控制，方便软件来控制网络。
*   **特征**：
    *   **可编程性**：#SDN可编程 通过为开发者们提供强大的编程接口（北向接口），使得网络有很好的编程性。
    *   **控制平面和数据平面分离**：#SDN分离 两个层面相互分离，数据平面设备只负责数据转发。
    *   **逻辑上集中管理**：#SDN集中管理 对分布式网络状态的集中统一管理。逻辑集中控制为软件编程定义网络功能提供架构基础、网络自动化管理。
*   **SDN体系结构**：
    *   **SDN网络应用层**：实现了对应的网络功能应用（如负载均衡、防火墙等）。
    *   **北向接口（Northbound Interface）**：#北向接口 对上层应用的开发者，SDN提供的编程接口称为北向接口。北向接口提供了一系列丰富的API，开发者可以在此基础上设计自己的应用而不必关心底层的硬件细节。
    *   **SDN控制器（Control Plane）**：#SDN控制器 也称为网络操作系统。控制器不仅要通过北向接口为上层网络应用提供不同层次的可编程能力，还通过南向接口对SDN数据平面进行统一的配置、管理和控制。它掌握各主机和整个网络的状态，为每个分组计算出最佳路由，并将转发表下发给路由器。
    *   **南向接口（Southbound Interface）**：#南向接口 SDN控制器和转发设备建立双向会话的接口称为南向接口。通过不同的南向接口协议（如OpenFlow协议），SDN控制器就可以控制不同的硬件设备，同时可以在设备中实现上层应用的逻辑。
    *   **SDN数据平面（Data Plane）**：#SDN数据平面 是基于软件实现和硬件实现的数据平面设备（如SDN交换机、路由器）。路由器的工作很单纯，即收到分组、查找转发表、转发分组。
    *   **东西向接口（East-West Interface）**：#东西向接口 SDN控制器集群内部控制器之间的通信接口，用于增强整个控制平面的可靠性和可拓展性。
*   **SDN的优点**：
    *   **高性能与全局优化**：集中式控制和分布式高速转发，利于控制层面的全局优化、高性能的网络转发。
    *   **灵活可编程**：控制和转发功能分离，网络可由专有的自动化工具以编程方式配置。
    *   **降低成本**：控制和数据层面分离，使用开放的接口协议后，实现网络设备的制造与功能软件的开发相分离，有效降低成本。
*   **SDN的问题**：
    *   **安全风险**：集中管理容易受攻击，如果控制器崩溃，整个网络会受到影响。
    *   **扩展性问题**：原本分布式的控制层面集中化后，随着网络规模扩大，控制器有可能成为网络性能的瓶颈。
*   **补充**：SDN结构中，路由选择软件不再需要了，路由器之间不再相互交换路由信息。在网络的控制层面有一个逻辑上的远程控制器（可以由多个服务器组成）。远程控制器掌握各主机和整个网络的状态，为每个分组计算出最佳路由，通过OpenFlow协议（也可以通过其他途径）将转发表下发给路由器。路由器的工作很单纯，即收到分组、查找转发表、转发分组。

### **5. 拥塞控制**
*   **概念**： #拥塞 #拥塞控制
    *   如果网络的吞吐量随着网络负载的增大而下降，网络就有可能进入了拥塞状态。
    *   **拥塞**指到达通信子网中某一部分（如某个路由器或链路）的分组数量过多，使得该部分网络来不及处理，以致引起这部分乃至整个网络性能下降（如吞吐量下降、时延增加、分组丢失）的现象。
    *   **拥塞控制**的作用是确保子网能够承载所达到的流量，防止过多数据注入网络，从而使网络中的路由器或链路不致过载。它是一个**全局性过程**，涉及到所有的主机、所有的路由器以及所有与降低网络传输性能有关的因素。
*   **流量控制与拥塞控制的区别**：  #拥塞控制与流量控制
    *   **流量控制**：着眼于**发送端和接收端之间的点对点通信**的控制。流量控制抑制发送端发送数据的速率，使接收端来得及接收，防止接收方缓存溢出。它是一个**端到端问题**。
    *   **拥塞控制**：着眼于**整个网络（子网）**，防止过多数据注入网络而导致网络性能下降。它是一个**全局性问题**。
*   **拥塞控制方法**：
    *   **开环控制**： #开环控制 事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。这是一种**静态的预防方法**，系统一旦启动并运行，中途不再需要修改。例如：准入控制、流量预留等。
    *   **闭环控制**： #闭环控制 事先不考虑有关发生拥塞的各种因素，基于反馈环路的概念，是一种**动态的方法**。它在系统运行中动态监测网络拥塞情况，并根据反馈信息采取调整措施。例如：拥塞窗口调整、源站抑制、路由更新等。

### **6. 网际协议IP及其配套协议**
*   **网际协议IP**是TCP/IP体系中两个最主要的协议之一（另一个是TCP）。
*   **与IP协议配套使用的还有三个主要协议**：
    *   **地址解析协议ARP** (Address Resolution Protocol)
    *   **网际控制报文协议ICMP** (Internet Control Message Protocol)
    *   **网际组管理协议IGMP** (Internet Group Management Protocol)
*   **三个协议与网际协议IP的关系**：

```plaintext
    应用层
    传输层 (TCP/UDP)
    网络层
      IP协议
      ARP (最下面，IP经常使用)
      ICMP/IGMP (在IP的上部，使用IP协议)
    数据链路层
    物理层 (物理硬件)
```

   *   ARP在IP协议的"最下面"，因为IP经常要使用它来解析MAC地址。
   *   ICMP和IGMP在IP协议的"上部"，因为它们要封装在IP数据报的数据部分，并使用IP协议进行传输。
图4-2 网际协议 IP 及其配套协议

## **04-2 IPv4**
### **1. IPv4分组**
*   **IPv4首部结构**： #IPv4首部
    图：IP数据报首部和数据部分（发送在前）![[04-网络层-1761475003009.png|561x335]]
*   **字段含义**：
    *   **版本**：占4 bit，指IP的版本。IPv4为`0100`。
    *   **首部长度**：占4 bit，可表示最大十进制数是15。以32位(4B)为单位，最大值为60B (15x4B)。最常用首部长度是20B（无选项字段）。用于指示IP数据报首部的总长度，方便接收端正确解析数据部分。
    *   **服务类型 (ToS)**：占8 bit，用来获得更好的服务（QoS）。在IPv4中实际应用较少。
    *   **总长度**：占16 bit，首部和数据之和的长度，单位为字节(1B)。数据报的最大长度为$2^{16}-1 = 65535$B。以太网帧的最大传送单元(MTU)为1500B，IP数据报封装成帧时，数据报总长度一定不能超过下面的数据链路层的MTU值。
    *   **标识**：占16 bit，是一个计数器，每产生一个数据报就加1。当一个数据报的长度超过网络的MTU时，必须分片，**每个数据报片都复制一次标识号**，以便目的主机重装成原来的数据报。属于同一个数据报的各分片有相同的标识。#分片标识
    *   **标志**：占3 bit。标志字段的最低位为 **MF (More Fragment)**，MF=1表示后面还有分片，MF=0表示最后一个分片。标志字段中间一位是 **DF (Don't Fragment)**，只有当DF=0时才允许分片，DF=1表示不允许分片，如果需要分片则丢弃。#分片标志
    *   **片偏移**：占13 bit，指出较长的分组在分片后，某片在原分组中的相对位置。片偏移以8个字节(8B)为偏移单位。目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始IP数据报的哪个位置。#片偏移
    *   **生存时间TTL (Time To Live)**：占8 bit。路由器在转发分组前，先把TTL减1。若TTL被减为0，则该分组必须丢弃。**防止数据报在网络中无限循环**。 #TTL
    *   **协议**：占8 bit，指出此分组携带数据使用何种协议，分组数据部分应交给哪个传输层协议。其中值为6表示TCP，值为17表示UDP，值为1表示ICMP。 #上层协议类型
    *   **首部校验和**：占16 bit，**只校验分组的首部，而不校验数据部分**。每经过一个路由器，TTL字段会减1，导致首部改变，因此**首部校验和都会重新计算**。#首部校验和
    *   **源地址字段**：占4B (32 bit)，标识发送方IP地址。#源IP
    *   **目的地址字段**：占4B (32 bit)，标识接收方IP地址。#目的IP
    *   **选项字段**：可变长度，用来排错，测量及安全等措施。最长可达40字节。
    *   **填充字段**：可变长度，确保首部长度为4字节的整数倍。使用全0进行填充。
*   **分片**： #分片
    *   **MTU (Maximum Transmission Unit)**：一个数据链路层数据报能承载的最大数据量。MTU严格限制着IP数据报长度。
    *   当IP数据报总长度大于MTU时，路由器或源主机将IP数据报中数据封装在多个较小的IP数据报中（片）。片在**目的地的网络层**被重新组装。目的主机使用IP首部中的标识、标志和片偏移字段来完成对片的重组。
        *   **标识**：创建一个IP数据报时，源主机为该数据报加上一个标识号。当一个路由器需要将一个数据报分片时，形成的每个片都具有原始数据报的标识号。目的主机收到来自同一主机的一批数据报时，它可以通过检查数据报的标识号来确定哪些数据报属于同一个原始数据报的片。
        *   **标志 (MF/DF)**：首部中标志位有3比特，但只有后2比特有意义。DF位（Don't Fragment）为0时，该IP数据报才可以被分片。MF位（More Fragment）用来告知目的主机该IP数据报是否为原始数据报的最后一个片。当MF=1时，表示相应的原始数据报还有后续的片；当MF=0时，表示该数据报是相应原始数据报的最后一个片。
        *   **片偏移字段**：目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始IP数据报的哪个位置。片偏移值的单位是8B，除最后一个片外，其他所有片中的有效数据载荷都是8的倍数。
    *   **分片示例**：一个长4000B的IP数据报（首部20B，数据部分3980B）到达一个路由器，需要转发到一条MTU为1500B的链路上。假定原始数据报的标识号为777，分成3片。片偏移值的单位是8B，除最后一个片外，其他所有片中的有效数据载荷都是8的倍数。

```plaintext
        原始数据报 (标识=777, MF=0, DF=0, 总长度=4000B, 数据=3980B)
        [首部20B | 数据0-3979]
        
        MTU = 1500B
        每个分片最大数据载荷 = MTU - 首部长度 = 1500B - 20B = 1480B
        1480B 是 8B 的 185 倍 (1480/8 = 185)
        
        片1: (标识=777, MF=1, DF=0, 总长度=1500B, 数据=1480B)
             [首部20B | 数据0-1479] 片偏移=0
        片2: (标识=777, MF=1, DF=0, 总长度=1500B, 数据=1480B)
             [首部20B | 数据1480-2959] 片偏移=185 (1480/8)
        片3: (标识=777, MF=0, DF=0, 总长度=1040B, 数据=1020B) (3980 - 1480 - 1480 =1020)
             [首部20B | 数据2960-3979] 片偏移=370 (2960/8)
 ```

*   **IP分组转发**：
    1.  从数据报的首部提取目的主机的IP地址D，得出目的网络地址N。
    2.  若网络N与此路由器直接相连，则把数据报直接交付给目的主机D；否则是间接交付，执行步骤3。
    3.  若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行步骤4。
    4.  若路由表中有到达网络N的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行步骤5。
    5.  若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行步骤6。
    6.  报告转发分组出错（将分组丢弃，并发送ICMP目的不可达报文）。
*   **Notes**：
    *   得到下一跳路由器的IP地址后，并不能直接将该地址填入待发送的数据报。而是将该IP地址转换成MAC地址（通过ARP），将其放至MAC帧首部中，然后根据这个MAC地址找到下一跳路由器。
    *   当数据报在不同网络中传送时，MAC帧中的源地址和目的地址要发生变化，但是网桥转发帧时，不改变帧的源地址。
    *   路由表并没有给分组指明到某个网络的完整路径。路由表指出，到某个网络应当先到某个路由器（下一跳）。在到达以后，继续查找路由表，知道再下一步到哪个路由器。

### **2. IPv4地址与NAT**
*   **IPv4地址**： #IPv4地址
    * **定义**：每台主机（路由器）的每个接口分配的32位全球唯一地址。
    * **表示**：通常用**点分十进制**表示（例如 `192.168.1.10`），每段是 0 到 255 的十进制数。
    * **组成**：IP地址由两部分组成：`｛〈网络号〉，〈主机号〉｝`。
        *   **网络号**：标志主机所连接的网络，整个互联网中唯一。
        *   **主机号**：标志该主机，在当前网络号范围内唯一。
    *   **特点**：
        *   IP地址管理机构只负责分配网络号，而主机号由本地自行分配。
        *   路由器转发分组时只根据网络号。
        *   IP地址标志一台主机（路由器）和一条链路的接口，主机（路由器）链接两个不同网络时，至少要两个IP地址，网络号必须不同。
        *   划分为网络相同的主机在同一个网络，同一个广播域。用转发器（物理层）或网桥（数据链路层）连接起来的若干个局域网仍为一个网络。
        *   所有分配到网络号的网络（局域网LAN/广域网WAN）都是平等的，互联网同等对待每一个IP地址。
        *   同一个局域网上的主机（路由器）IP地址中网络号必须一样。
*   **地址分类**： #地址分类
    *   IPv4地址分为A、B、C、D、E五类。A、B、C类为单播地址，D类用于多播，E类保留。

```plaintext
        32 位
        A 类地址   0   |  网络号 (7 bits)  |    主机号 (24 bits)
        B 类地址   10  |  网络号 (14 bits) |    主机号 (16 bits)
        C 类地址   110 |  网络号 (21 bits) |    主机号 (8 bits)
        D 类地址   1110|       多播地址 (28 bits)
        E 类地址   1111|       保留为今后使用 (28 bits)
```

* then
    * **A类地址**：
        *   网络号字段占1个字节，第1位固定为0。可指派网络号`2^7-2`个 (1-126)。
            *   全0表示"这个网络上这个主机"，网络号全0的IP地址表示"本网络"。
            *   网络号127 (01111111) 为环回测试。
        *   主机号字段占3个字节，最大主机数`2^24-2`个。
            *   全0的主机号表示"本主机"连接到的单个网络地址。
            *   全1表示该网络上的所有主机（直接广播地址）。
    *   **B类地址**：
        *   网络号字段占2个字节，前2位固定为10。可指派网络号`2^14-1`个 (128.0-191.255)。
            *   128.0.0.0不指派。
        *   主机号字段占2个字节，最大主机数`2^16-2`个（扣除全0和全1主机号）。
    *   **C类地址**：
        *   网络号字段占3个字节，前3位固定为110。可指派网络号`2^21-1`个 (192.0.0-223.255.255)。
        *   主机号字段占1个字节，最大主机数`2^8-2`个。
*   **特殊地址**： #特殊地址

| 特殊地址          | 网络号 | 主机号    | 用途/说明                                               |
| :------------ | :-- | :----- | :-------------------------------------------------- |
| **网络地址**      | 特定  | 全 0    | 标识一个网络（或子网），不能作为主机IP，用作目的地址。|
| **直接广播地址**    | 特定  | 全 1    | 向特定网络上的所有主机发送报文，路由器转发，用作目的地址。|
| **受限广播地址**    | 全 1 | 全 1    | `255.255.255.255`，仅限于本地网络广播，路由器不转发，用作目的地址。|
| **本网络上的本主机**  | 全 0 | 全 0    | `0.0.0.0`，指本网络上的本主机，常用于DHCP客户端的源地址，或默认路由的目的地址。|
| **本网络上的特定主机** | 全 0 | 特定     | `0.0.0.X`，表示本网络上的特定主机，通常被路由器限制在本地网络。|
| **环回地址**      | 127 | 非全0/全1 | `127.x.y.z`（通常`127.0.0.1`），用于本地软件测试。既可作源地址，也可作目的地址。|
*    *   **直接广播地址 (主机号全1)**：
        *   路由器使用直接广播地址向一个本地网络上的每一个主机发送报文，每一个主机、路由器接收和处理具有直接广播地址的分组。
        *   A、B、C类地址中，若主机号全1，称直接广播地址。路由器使用该地址把一个分组发送给特定网络上所有主机，所有主机都接收和处理这个分组。
        *   这类地址在IP分组中只能用作目的地址。
    *   **环回地址 (网络号127)**：
        *   127的小地址作为一个字节作为环回地址，用来测试机器的软件。
        *   使用这个地址时，分组永远不离开这个机器，分组简单地返回到协议软件，用来测试IP软件。
        *   `ping 127.0.0.1`应用程序：发送把环回地址作为目的地址的分组，测试IP软件能否接收和处理分组；客户进程用环回地址发送报文给同样机器上的服务器进程。
        *   在IP分组中既能用作目的地址，也能用作源地址。
        *   实际上是A类地址，环回地址会使A类地址中的网络数减少一个。
    *   **本网络上的本主机 (0.0.0.0)**：
        *   IP地址为0.0.0.0，表示"本网络上的本主机"。
        *   当一个主机不知道自己的IP地址（例如DHCP客户端刚启动时），主机为要发现自己的IP地址，就给引导服务器发送IP分组，并使用`0.0.0.0`作为源地址，并且使用`255.255.255.255`作为目的地址（受限广播）。
        *   此地址是一个A类地址，A类地址网络减少一个。
    *   **本网络上的特定主机 (网络号全0)**：
        *   具有全0的网络号的IP地址（`0.0.0.X`）表示"在这个网络上的特定主机"。
        *   用于当某个主机向同一网络上的其他主机发送报文时。
        *   分组通常会被路由器挡住，把分组限制在本地网络上的一种方法。
        *   是一个A类地址。
    *   **受限广播地址 (网络号和主机号全1)**：
        *   IP地址为`255.255.255.255`，用于定义在**当前网络**（不是整个因特网）上的广播地址。
        *   一个主机若想把报文发送给所有其他主机，可使用这样的地址作为分组中的目的地址，但路由器会把这种类型的地址阻拦，使这样的广播仅局限于本地局域网。
        *   这种地址属于E类地址（但通常认为它是特殊广播地址，不归属到常规分类地址中）。
*   **网络地址转换（NAT）**： #NAT
    *   **定义**：通过专用网络地址转换为公用地址，对外隐藏内部管理的IP地址。
    *   **目的**：使得整个专用网只需要一个全球IP地址就可以与因特网连通，缓解IPv4地址枯竭问题。
    *   **私有地址**：#私有地址
        *   私有地址是可重用地址，只能用于局域网内部，不能用于广域网。
        *   **路由器对目的地址是私有地址的数据报一律不进行转发**（因为私有地址在公网上无效）。
        *   私有地址必须通过网关利用NAT转换为合法的全球IP地址后才能用于在Internet中通信。
        *   **私有IP地址网段**：
            *   A类：1个A类网段，即`10.0.0.0` ~ `10.255.255.255`。
            *   B类：16个B类网段，即`172.16.0.0` ~ `172.31.255.255`。
            *   C类：256个C类网段，即`192.168.0.0` ~ `192.168.255.255`。
    *   **工作原理**：
        *   NAT路由器内部维护一张**NAT转换表**，记录着`｛本地IP地址：端口｝`到`｛全球IP地址：端口｝`的映射。
        *   当使用私有IP地址的主机向互联网发送数据报时，NAT路由器接收到该数据报后会根据NAT转换表将该数据报中的源IP地址（和端口号）更换成合法的全球IP地址（和端口号），然后再转发给Web服务器或目的主机。反之亦然。
    *   **NAT与普通路由器的区别**：
        *   普通路由器在转发IP数据报时，**不改变其源IP地址和目的IP地址**。而NAT路由器在转发IP数据报时，要**更换其IP地址**（转换源IP地址或目的IP地址）。
        *   普通路由器仅工作在网络层。而NAT路由器转发数据报时需要查看和转换**传输层的端口号**（尤其是PAT/NAPT），所以NAT通常认为工作在传输层。
### **3. 子网划分与子网掩码、CIDR**
*   **子网划分**： #子网划分
    *   **概念**：内部将IP地址进一步分级，形成三级IP地址：`<网络号> <子网号> <主机号>`的结构。路由器会先找到目的子网然后再转发给目的主机。
    *   **思想**：从原有IP地址的**主机号**中借用若干比特作为**子网号**，主机号相应减少相同比特。
    *   **目的**：解决IP地址利用率低的问题，减少广播域，便于管理。
    *   **特点**：
        *   子网划分纯属内部的事情。对外仍然表现为没有划分子网的网络。
        *   从一个IP地址本身或IP数据报的首部，无法判断源主机或目的主机所连接的网络是否进行了子网划分。**必须借助子网掩码来判断。**
        *   **注意**：在进行子网划分时，通常规定**子网号不能为全1或全0**（虽然在CIDR中已不强制要求）。
        *   子网中的主机号为全0或全1的地址都不能被指派。主机号全0的地址为子网的**网络地址**，主机号全1的地址为子网的**广播地址**。
*   **子网掩码**： #子网掩码
    *   **定义**：一个 **32 位**的二进制数字，由连续的1和连续的0组成。用于**区分 IP 地址中哪一部分是网络号，哪一部分是主机号**。其中1对应IP地址中的网络号和子网号部分，0对应主机号部分。
    *   **优点**：只要把子网掩码和IP地址进行**逐位"与"运算**，就可以得出网络地址（主机号变为全0）。
    *   **分组转发步骤（含子网掩码）**：
        1.  路由器从分组首部提取目的IP地址D。
        2.  判断是否直接交付：对路由器直接相邻网络的子网掩码和D逐位相"与"，看是否和相应网络地址匹配。若匹配，则将分组直接交付，否则就是间接交付。
        3.  若路由表中有目的地址为D的特定主机路由，则将分组传送给指明的下一跳路由器，否则执行步骤4。
        4.  对路由表中的每一行的子网掩码和D逐位相"与"。若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行步骤5。
        5.  若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行步骤6。
        6.  报告转发分组出错（将分组丢弃）。
    *   **总结**：
        *   主机设置IP地址信息的同时，必须设置子网掩码。所有网络必须有一个子网掩码，如果一个网络没有划分子网，就采用默认子网掩码。
        *   **默认子网掩码**：A类地址`255.0.0.0`；B类地址`255.255.0.0`；C类地址`255.255.255.0`。
        *   属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码。
        *   路由器的路由表中，所包含信息的主要内容必须有目的网络地址、子网掩码、下一跳地址。
        *   同一个IP地址和不同的子网掩码可以得到相同的网络地址。
        *   子网掩码是一个网络或子网的重要属性，必须把自己所在网络的子网掩码告诉临近路由器。
*   **无分类编址CIDR (Classless Inter-Domain Routing)**： #CIDR #无分类编址
    *   **目的**：取代A、B、C类地址及划分子网的概念，更有效地分配IPv4地址空间，减小路由表规模。
    *   **编址方式**：CIDR使用可变长的"网络前缀"的概念代替子网。IP地址无分类两级编址为`｛<网络前缀>，<主机号>｝`。
    *   **格式**：CIDR使用"斜线记法" (Slash Notation)，即`IP地址/网络前缀所占比特数`,`192.168.1.0/24`。网络前缀所占比特数对应于网络号的部分，等效于子网掩码中连续1的部分。通过逐位相"与"的方法得到该地址的网络前缀。
    *   **CIDR地址块**：
        *   CIDR地址块中地址数一定是`2`的整数次幂。实际可指派的地址数通常为`2^N-2`（N为主机号的位数），主机号全0代表网络号，主机号全1为广播地址。
        *   路由聚合（构成超网）： #路由聚合 #超网
            *   多个网络前缀都相同的连续IP地址组成"CIDR地址块"。一个CIDR地址块可以表示很多地址。
            *   路由聚合使得路由表中的一个项目可以表示多个原来传统分类地址的路由，有利于减少路由器之间的路由选择信息的交换，从而减小路由表规模。
            *   网络前缀长度的灵活性：上层网络的前缀长度较短，相应的路由表的项目较少。内部可采用延长网络前缀的方法来灵活地划分子网（即**变长子网掩码VLSM**）。
    *   **最长前缀匹配**： #最长前缀匹配
        *   使用CIDR，路由表中的每个项目由"网络前缀"和"下一跳地址"组成。在查找路由表时可能会得到不止一个匹配结果。
        *   **应当从匹配结果中选择具有最长网络前缀的路由**。网络前缀越长，地址块就越小，路由就越具体。这是CIDR环境下路由查找的核心原则。

### **4. ARP协议、DHCP协议与 ICMP协议**
*   **网络层分组转发的过程（综合）**：
    1.  从分组首部提取目的IP地址。
    2.  若路由表中有目的地址为D的**特定主机路由**，则直接转发到指定下一跳。
    3.  若目的IP与路由器某个直连网络在**同一子网**，则直接交付（通过ARP获取MAC地址）。
    4.  遍历路由表的每一行，将**子网掩码**和目的IP地址进行**与运算**得到网络号，查看能否与路由表表项匹配。若能匹配，则转发到记录的下一跳。
    5.  若路由表中未查到具体表项但有**默认路由**，则执行默认路由。
    6.  否则，丢弃，并报告分组转发出错（发送ICMP目的不可达报文）。

*   **IP地址与硬件地址**：
    *   **IP地址**是网络层使用的地址，是一种**逻辑地址**，分层次等级的。
    *   **硬件地址（MAC地址）** 是数据链路层和物理层使用的地址，它是**平面式**的（全球唯一）。
    *   在网络层及网络层以上使用IP地址。数据链路层及以下使用的是硬件地址。
    *   IP地址放在IP数据报的首部。MAC地址放在MAC帧的首部。通过数据封装，把IP数据报分组封装为MAC帧后，数据链路层看不见数据报分组中的IP地址。
    *   由于路由器的隔离，IP网络中无法通过广播方式依靠MAC地址来完成网络寻址，在IP网络的网络层只使用IP地址来完成寻址。

*   **地址解析协议ARP**： #ARP
    *   **用途**：解决同一个**局域网内**IP地址和MAC地址的映射问题。
    *   **原理**：
        *   局域网内每台主机都动态维护**ARP表（ARP缓存）**，记录本局域网上各主机和路由器的IP地址到MAC地址的映射。ARP表中的映射有生存时间（TTL），过期后会自动删除。
        *   局域网内主机A想向B主机发送信息时，如果ARP表记录了B的MAC地址，直接封装MAC帧发送给B。
        *   如果没有记录，A会使用`FF-FF-FF-FF-FF-FF`作为目的MAC地址来进行**ARP请求广播**，本局域网所有主机运行ARP都能收到。ARP请求报文中包含源IP、源MAC和目的IP（请求MAC）。
        *   B收到该请求后，将ARP请求中的A的IP-MAC映射加入自己的ARP缓存，然后给A发送**ARP响应分组**（单播），告诉A自己的IP地址与MAC地址的映射关系。
        *   A收到ARP响应后，更新ARP表，再进行MAC帧发送。
    *   **ARP工作场景**：
        *   **主机找同网主机**：发送方是主机时，要把IP数据报发送到本网络上的另一台主机。这时用ARP找到目的主机的硬件地址。
        *   **主机找异网主机**：发送方是主机时，要把IP数据报发送到另一个网络上的一台主机。这时用ARP找到**本网络上的默认网关路由器**的硬件地址，剩下的工作由这个路由器来完成。
        *   **路由器找同网主机**：发送方是路由器时，要把IP数据报转发到本网络上的一台主机。这时用ARP找到目的主机的硬件地址。
        *   **路由器找异网路由器**：发送方是路由器时，要把IP数据报转发到另一个网络上的一台主机。这时用ARP找到**下一跳路由器**的硬件地址。
    *   **要点**：
        *   IP地址到硬件地址的解析是**自动进行**的，用户并不知道地址解析过程。ARP自动将IP地址解析为数据链路层所需要的硬件地址。
        *   ARP缓存表映射地址都设置生存时间，超过时间就删掉。
        *   ARP请求分组是**广播发送**，ARP响应分组是**单播发送**。

*   **动态主机配置协议DHCP**： #DHCP
    *   **提供即插即用的联网方式**，允许一台计算机加入新的网络时能被动态地分配IP地址而不用手动参与。DHCP是**应用层协议**，基于UDP传输，服务器监听**67号端口**，客户端监听**68号端口**。![[考研学习笔记04-计算机网络 00 计网每日一题 今天21_29.png]]
    *   **工作原理（四报文交互过程）**：
        1.  **DHCP Discover（发现）**：DHCP客户机广播"DHCP发现"消息，试图找到网络中的DHCP服务器，以便从DHCP服务器获得一个IP地址。**（源IP：0.0.0.0；目的IP：255.255.255.255；源MAC：客户端MAC；目的MAC：`FF-FF-FF-FF-FF-FF`）**
        2.  **DHCP Offer（提供）**：DHCP服务器收到"DHCP发现"消息后，向网络中广播"DHCP提供"消息，其中包含提供给DHCP客户机的IP地址和相关配置信息。
        3.  **DHCP Request（请求）**：DHCP客户机收到"DHCP提供"消息，如果接收DHCP服务器所提供的相关参数，通过广播"DHCP请求"消息向DHCP服务器请求提供IP地址。
        4.  **DHCP ACK（确认）**：DHCP服务器广播"DHCP确认"消息，将IP地址分配给DHCP客户机。

*   **网际控制报文协议ICMP**： #ICMP
    *   **用途**：
        *   ICMP报文来让主机或路由器报告差错或者异常情况。
        *   ICMP报文作为IP层数据报的**数据部分**，加上IP数据报首部，组成IP数据报发送出去。
    *   **ICMP报文类型**：
        *   **ICMP差错报告报文**：
            *   **目的不可达**（无法交付）：当路由器找不到目的地址，或者目的网络/主机/端口不可达时。
            *   **源点抑制**（拥塞后丢数据）：当路由器发现自身出现拥塞时，通知发送方减慢发送速率。
            *   **时间超过**（生存时间TTL=0）：当数据报的TTL减为0时，路由器丢弃数据报并发送此报文给源主机。
            *   **参数问题**（首部字段有问题）：当路由器或主机收到IP数据报首部字段有错误或无法处理时。
            *   **改变路由/重定向**：路由器通知主机有更好的路由路径。
        *   **ICMP询问报文**：
            *   **回送请求和回答报文**：用于测试目的站是否可达以及其有关状态（`ping`命令的底层实现）。
            *   **时间戳请求和回答报文**：用于时钟同步和时间测量。
            *   **掩码请求和回答报文**：用于主机查询子网掩码（已很少使用）。
            *   **路由器询问和通告报文**：用于主机发现本地网络上的路由器。
    *   **不发送ICMP差错报告报文的情况（例外）**：
        *   对ICMP差错报告报文本身不再发送ICMP差错报告报文（避免无限循环）。
        *   对第一个分片以外的其他分片（所有后续分片）不发送ICMP差错报告报文。
        *   对具有组播地址的数据报都不发送ICMP差错报告报文。
        *   对具有特殊地址（如`127.0.0.0`或`0.0.0.0`）的数据报不发送ICMP差错报告报文。
    *   **常见应用**：
        *   `ping`操作使用的是ICMP**回送请求**和**回答报文**。
        *   `traceroute`操作使用的是ICMP**时间超过**报文（通过逐步增加TTL值探测路径）。

## **04-3 IPv6**

### **1. IPv6的主要特点**
*   **地址长度**： #IPv6 具有**128位**地址，彻底解决了IPv4地址耗尽的问题，提供了巨大的地址空间。
*   **简化首部**：IPv6首部为**固定40字节**，相较于IPv4的变长首部更简单高效，有利于硬件高速转发。
*   **移除了字段**：IPv6首部**移除了**IPv4的**首部校验和**（由链路层和传输层负责），**标识**、**标志**、**片偏移**字段（分片由源主机完成，中间路由器不分片），**服务类型**字段（功能由流量类和流标签替代）。
*   **扩展支持**：#IPv6扩展
    *   内置了对**QoS（服务质量）**的更好支持，如**流标签（Flow Label）**。
    *   内置了**安全性**支持（如 #IPSec，IPsec在IPv6中是强制要求实现的）。
    *   **即插即用**：支持**无状态地址自动配置（SLAAC）**，主机可以根据路由器通告信息自动配置IP地址，无需DHCP服务器。#SLAAC
*   **更高效的路由**：由于地址层次性更好，路由表可以更小，查找更快。
*   **无广播**：IPv6中不再有广播地址，取而代之的是**多播**（Multicast）和**任播（Anycast）**，减少了网络中的 #广播风暴 。

### **2. IPv6数据报的基本首部**
*   **固定40字节**：所有IPv6数据报的首部都是固定的40字节。#IPv6首部
*   **重要字段**：
    *   **版本（Version）**：4位，固定为6。
    *   **流量类（Traffic Class）**：8位，类似IPv4的服务类型，用于区分数据报的优先级和QoS。
    *   **流标签（Flow Label）**：20位，用于标记属于同一流（例如，实时视频流）的数据报，以便路由器进行高效、一致的处理，提供更细粒度的QoS。 #流量类 #流标签
    *   **有效载荷长度（Payload Length）**：16位，指明IP数据报除基本首部以外的字节数（即扩展首部+数据部分），最大长度65535字节。
    *   **下一个首部（Next Header）**：8位，指明下一个首部的类型（可以是扩展首部，也可以是上层协议，如TCP=6，UDP=17）。
    *   **跳数限制（Hop Limit）**：8位，类似IPv4的TTL，每经过一个路由器减1，减到0丢弃。
    *   **源地址（Source Address）**：128位，发送方IP地址。
    *   **目的地址（Destination Address）**：128位，接收方IP地址。
*   **扩展首部（Extension Headers）**：IPv6设计了灵活的扩展首部机制，将IPv4中一些不常用或可选的功能（如分片、安全性、路由选项等）移到扩展首部中。只有在需要时才添加扩展首部，提高了转发效率。

### **3. IPv6地址**
*   **表示方法**：#IPv6地址表示 通常采用**十六进制冒分表示法**。
    *   地址中每4位用一个十六进制数表示，并用冒号分隔每16位。例如：`2001:0db8:85a3:0000:0000:8a2e:0370:7334`
    *   **压缩表示**：
        *   16位域开头有一些0时，采用缩写表示法，域中必须至少有一个数字（如`0db8`可写成`db8`）。
        *   相继的0值域时，进一步缩写。用双冒号`::`缩写。**双冒号表示法在一个地址中仅能出现一次**。例如：`2001:db8::8a2e:370:7334`。
*   **IPv6地址分类**：#IPv6地址类型
    *   **未指明地址（Unspecified Address）**：16字节的全0地址，缩写为`::`，不能用作目的地址，只能为某台主机当作源地址使用（如DHCPv6请求）。
    *   **环回地址（Loopback Address）**：地址`0:0:0:0:0:0:0:1`，可缩写为`::1`，与IPv4的`127.0.0.1`功能类似，用于本地软件测试。
    *   **单播地址（Unicast Address）**：#单播 唯一标识一个网络接口，数据发送给该接口。包括：
        *   **全球单播地址**：类似IPv4的公网地址，全球唯一。
        *   **本地链路单播地址**：#本地链路单播地址 以`fe80::/10`开头，仅在本地链路上有效，不能路由到其他网络。连接网络上的主机都可以和本地地址进行通信，不能和互联网其他主机通信。
    *   **多播地址（Multicast Address）**：#多播 标识一组接口，数据发送给组内所有成员（对应IPv4的D类地址）。所有多播地址都以`FF`开头。
    *   **任播地址（Anycast Address）**：#任播 标识一组接口，数据发送给组内**最近的**一个成员（由路由协议决定"最近"）。

### **4. 从IPv4向IPv6过渡**

> [!NOTE] 常见过渡技术 #IPv4到IPv6过渡
> 由于IPv4和IPv6协议不兼容，且需要长期共存，过渡技术至关重要：
> 1.  **双栈协议（Dual Stack）**：#双栈 指在一台设备（主机或路由器）上同时装有IPv4和IPv6协议栈，可以根据需要选择使用IPv4或IPv6通信。这是最直接和常用的方法，允许设备同时拥有IPv4和IPv6地址。
> 2.  **隧道技术（Tunneling）**：#隧道技术 将一个协议的数据报封装在另一个协议的数据报中。例如，将IPv6数据报封装在IPv4数据报的数据部分，使得IPv6数据报可以在IPv4网络的隧道中传输。反之亦然。这使得IPv6孤岛可以通过IPv4基础设施进行通信。
> 3.  **NAT-PT（协议转换）**：#NAT-PT Network Address Translation - Protocol Translation。在IPv4和IPv6网络边界处，将IPv6数据包转换为IPv4数据包，或将IPv4数据包转换为IPv6数据包，实现两种协议之间的互操作。它同时进行地址和协议头的转换。

## **04-2 路由算法**
### **1. 静态路由与动态路由**
*   **静态路由算法（非自适应路由算法）**： #静态路由
    *   **概念**：由网络管理员手工配置的路由信息，一旦配置后，除非人工修改，否则路由不会改变。
    *   **类型**：包括直接配置网络路由、默认路由、特定主机路由、黑洞路由等。
    *   **特点**：人工配置方式简单、开销小。适用于小型、稳定、拓扑变化不频繁的网络。
    *   **缺点**：不能及时适应网络状态变化，当网络拓扑发生故障或变化时，需要手动调整，易导致路由环路。
*   **静态路由配置可能导致的路由环路问题**：
    *   **路由配置错误导致路由环路**：
        *   **举例**：R2路由表设置错误，原本192.168.1.0/24网络下一跳应是R1的接口1，错误配置成R3的接口0。当发送数据报时，先发送到R3的端口0，查找R3的路由表，发现目的地址对应的下一跳为R2的端口1，又进行了转发后，就形成了一个路由环路。
        *   **解决办法**：IP数据报首部设置**生存时间TTL字段**，进入路由器后，TTL值减1。如果TTL值等于0，数据报会被丢弃，从而防止数据报在路由环路中无限循环。
    *   **聚合了不存在的网络而导致路由环路**：
        *   **举例**：R2路由表中设置一条聚合路由，将对R2来说下一跳相同的两个网络选取共同前缀聚合，得到聚合网络192.168.0.0/22。但聚合路由中可能包含了R2不可达或不存在的网络（如192.168.0.0/24和192.168.3.0/24）。当R2要发送数据报到192.168.3.0/24时，数据报会匹配到聚合路由发往R1。R1查找路由表，没有该网络的具体路由，就会按默认路由转发回R2，形成环路。
        *   **解决办法**：在R2路由表中设置针对这些不存在网络的**黑洞路由**（Null0接口）。数据报的目的地址如果匹配黑洞路由的目的网络，就会被丢弃而不被转发，防止进入环路。
    *   **网络故障导致路由环路**：
        *   当某个网络路径发生故障时，如果静态路由没有及时更新，数据包可能会被错误地转发到另一条路径上，而这条路径最终又导回起始路由器，形成环路。
        *   **解决办法**：除了TTL，同样可以设置**黑洞路由**来处理那些已知不可达的网络，或者**及时手动更新**路由配置。

*   **动态路由算法（自适应路由算法）**： #动态路由
    *   **概念**：由相互连接的路由器之间彼此交换信息，并根据网络状态（如链路开销、拓扑变化等）动态更新路由表。
    *   **特点**：能较好地适应网络状态的变化，自动发现和选择最佳路径，实现路由的自适应。适用于大型、复杂和拓扑频繁变化的网络。
    *   **缺点**：实现起来比较复杂，需要消耗更多的路由器资源（CPU、内存、带宽）来交换和计算路由信息，开销较大。
    * 常用的动态路由算法分为 **距离-向量路由算法**和 **链路状态路由算法**。
### **2. 距离-向量路由算法**
#距离-向量路由算法 的基础是Bellman-Ford算法（用于计算单源最短路径）。每个节点以自身为源点执行 #Bellman-Ford算法 ，全局上可解决任意节点对之间的最短路径问题
假设$d_x(y)$表示从节点x到节点y的带权最短路径的费用，则有$d_x(y)=min{c(x,v)+d_v(y)}$v是x的所有邻居
![[考研学习笔记04-计算机网络 04-网络层 2025-10-21 2534.jpg|557x220]]
*   详见[[#**3. RIP路由协议**]]。
### 3. 链路状态路由算法
**链路状态**：本路由器和哪些路由器相邻，以及相应的链路代价
*   **链路状态路由算法节点任务**： #链路状态路由算法
    *   主动测试邻接节点的状态。相邻节点是指连接到同一条链路，或者连接到同一广播型物理网络的节点。
    *   定期地将链路状态传播给所有其他节点，采用**洪泛法（Flooding）**。
*   **链路状态路由算法特征**：
    *   **洪泛法**：向本自治系统中所有路由器发送信息，即路由器通过所有端口向所有相邻的路由器发送信息。每个相邻路由器又将此信息发往其所有相邻路由器，直到传遍整个自治系统。
    *   **发送的信息**：发送的信息是与路由器相邻路由器的**链路状态**。这里的"链路状态"是指说明本路由器与哪些路由器相邻，以及该链路的"代价"（Cost）。"代价"用来表示费用、距离、时延、带宽等等。
    *   **更新机制**：只有当链路状态发生变化时（事件驱动），路由器才向所有路由器发送此信息（LSA）。
*   **链路状态路由优点**：
    *   **独立计算与易于查找故障**：每个路由结点都使用同样的原始状态数据（LSDB）独立地计算路径，不依赖中间结点的计算；链路状态报文不加改变地传播，采用该算法易于查找故障。
    *   **一步汇聚**：一个结点从所有其他结点接收到报文时，它可以在本地立即计算正确的通路，保证一步汇聚（即收敛速度快）。
    *   **规模可伸缩性**：链路状态报文仅运载来自单个结点关于直接链路的信息，其大小与网络中的路由结点数目无关，有更好的规模可伸展性。

### **4. 层次路由**
![[04-网络层 2025-10-21 09.30.06.excalidraw|900]]
*   **内部网关协议（IGP, Interior Gateway Protocol）**： #IGP **自治系统内部**使用的路由选择协议。RIP OSPF
*   **外部网关协议（EGP, Exterior Gateway Protocol）**： #EGP **自治系统之间**使用的路由选择协议，主要在不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径。BGP-4

## **04-5 路由协议**
### **1. 自治系统**
*   **自治系统（AS, Autonomous System）**： #AS #自治系统 单一技术管理下的一组路由器，以及与这些路由器相连的网络。内部使用统一的内部路由选择协议（IGP），外部使用AS之间的路由协议（EGP）。每个AS都有一个全球唯一的AS号。
### **2. 域内路由与域间路由**
*   **域内路由选择**： #域内路由 自治系统内部的路由选择。使用内部网关协议（IGP），如RIP、OSPF、EIGRP、IS-IS。
*   **域间路由选择**： #域间路由 自治系统之间的路由选择。使用外部网关协议（EGP），如BGP。

### **3. RIP路由协议**

> [!NOTE] #RIP #路由信息协议
> RIP（Routing Information Protocol）基于**距离向量（Distance-Vector）算法**。

*   **工作原理**：
    *   RIP要求自治系统AS内的每一个路由器都要维护从它自己到其他每一个网络的距离记录。（一组距离，称为"距离向量"）。
    *   **跳数（Hop Count）** 表示到达目的网络距离。跳数指从源端到目的端所经过的路由器个数，每经过一个路由器，跳数加1。
    *   路由器到直连网络的距离定义为1。路由器到非直连网络的距离定义为所经过的路由器数加1。
    *   **最大跳数限制**：RIP允许一条路由最多只能包含15个路由器（跳数等于15）。"距离"等于16时相当于不可达。因此RIP只适用于**小型互联网**。
*   **基本工作过程**：
    *   路由器刚开始工作时，只知道自己到直连网络的距离为1。
    *   路由器仅和**相邻路由器**周期性地交换并更新自己**全部路由信息**（路由表）。
    *   路由器X发来的RIP报文，先修改报文项目：把"下一跳"字段中地址改为X，并把所有"距离"字段值加1。
    *   经过若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和下一跳地址，称为**收敛**。
    *   RIP收敛后，每个路由器到每个目标网络的路由都是距离最短的。
*   **路由条目更新规则**：
    *   发现新的网络，添加。
    *   到达目的网络，相同下一跳，最新消息，更新。
    *   到达目的网络，不同下一跳，新路由优势（距离短），更新。
    *   到达目的网络，不同下一跳，新路由劣势（距离长），不更新。
    *   到达目的网络，相同距离（等价负载均衡），可添加。
*   **RIP三问**：
    *   **和谁交换信息**：仅和**相邻路由器**交换信息。
    *   **交换什么信息**：自己的**整个路由表**（所有它知道的路由条目）。
    *   **何时交换信息**：**周期性**（一般是30秒）交换路由信息。
*   **特点**：
    *   RIP认为好的路由就是"距离短"的路由，所通过路由器数量最少的路由。
    *   当到达同一目的网络有多条"距离相等"的路由时，可以进行等价负载均衡。
*   **缺点**：
    *   **"坏消息传播得慢"（Count-to-Infinity Problem）**：这是距离向量算法的固有问题，当网络拓扑发生故障时，错误信息传播速度慢，容易产生 #路由环路 ，直到跳数达到16才认为不可达。
    *   **RIP限制了网络规模**，最大距离15（16不可达），不适用于大型网络。
    *   路由器交换**完整路由表**，开销大（占用带宽）。
    *   **解决"坏消息传播得慢"的措施**：
        *   当路由表发生变化时就立即发送更新报文（即**"触发更新"**）而不仅是周期性发送。
        *   路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即**"水平分割"**）。
        *   **毒性逆转**：当某个路由变为不可达时，将其距离设为16并通告出去。
*   **RIP报文格式**（了解）：由首部和路由部分组成，路由部分包含路由信息（目的网络地址、距离、下一跳等），最多可包含25个路由条目。

### **4. OSPF开放最短路径优先协议**

> [!NOTE] #OSPF #开放最短路径优先
> OSPF（Open Shortest Path First）基于**链路状态（Link-State）算法**，采用**Dijkstra（迪杰斯特拉）算法**计算最短路径。

*   **工作原理**：
    *   **链路状态通告（LSA）**：#LSA OSPF的每个路由器都会产生链路状态通告LSA。LSA被封装在链路状态更新分组LSU中，采用**洪泛法**（Flooding）发送。LSA中包含：
        *   本路由器的链路状态信息（如直连网络、接口带宽、开销等）。
        *   邻居路由器的链路状态信息。
    *   **链路状态数据库（LSDB）**：#LSDB 通过洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终将达到一致。每个路由器都建立一个链路状态数据库，实际是**全网的拓扑结构图**，在全网范围内一致（LSDB同步）。
    *   **最短路径计算**：每个路由器根据全网拓扑结构图，使用Dijkstra最短路径算法计算从自己到各自网络的最优路径，构造自己的路由表。
    *   **更新机制**：只有当链路状态发生变化时（事件驱动），路由器才发送LSA（洪泛），并重新计算到各目的网络的最优路径，构造新的路由表。
*   **基本特点**：
    *   OSPF是基于链路状态的，采用SPF算法计算路由，**保证不会产生路由环路**。
    *   OSPF不限制网络规模，更新效率高，收敛速度快。
    *   OSPF能够用于规模很大的网络，因为它把一个自治系统再划分为若干个更小的范围（**区域 Area**）。 #OSPF区域
        *   划分区域的好处：把利用洪泛法交换链路状态信息的范围局限于每一个区域，而不是整个自治系统，这就减少了整个网络上的通信量，提高了可扩展性。
        *   **主干区域（Area 0）** 是特殊区域，所有其他非主干区域都必须通过它进行通信。
    *   Dijkstra算出完整的最优路径，但是路由表中不会存储完整路径，只存储"下一跳"。
    *   OSPF能够将通信量分配给好几条路径，实现**多路径之间的负载平衡**。
    *   OSPF交换的分组都有**鉴别功能**，提高了可靠性。
    *   每个链路状态都有一个32位的序号，序号越大，状态就越新。
*   **OSPF分组类型**：
    1.  **Hello分组**：#Hello分组 发现和维护邻居路由器的可达性。
    2.  **数据库描述分组 (DD)**：#DD分组 向邻居路由器给出自己链路状态数据库中所有链路状态项目摘要，用于LSDB同步。
    3.  **链路状态请求分组 (LSR)**：#LSR分组 向邻居请求发送链路状态项目。
    4.  **链路状态更新分组 (LSU)**：#LSU分组 洪泛法对全网更新链路状态，包含LSA。
    5.  **链路状态确认分组 (LS Ack)**：#LSAck分组 对链路更新分组的确认。
*   **OSPF报文（了解）**：包含版本、类型、长度、路由器标识符、区域标识符、校验和、鉴别类型等字段。
*   **RIP和OSPF的区别**：

| 特征       | RIP                                  | OSPF                                     |
| :--------- | :----------------------------------- | :--------------------------------------- |
| **算法**   | 距离向量                             | 链路状态（Dijkstra算法）|
| **信息交换范围** | 仅向相邻路由器发送信息             | 向本自治系统内的所有路由器洪泛LSA      |
| **交换信息内容** | 自己的**整个路由表**                 | 与本路由器相邻的链路状态信息（LSA）|
| **何时交换信息** | 周期性（每30秒）交换信息             | 只有当链路状态发生变化时才发送LSA（事件驱动）|
| **收敛速度** | 慢（"坏消息传播得慢"，易形成环路）| 快（不易形成环路）|
| **度量**   | 跳数（最大15跳）| 开销（Cost，通常与带宽相关）|
| **网络规模** | 适用于小型网络                       | 适用于大型网络（支持区域划分）|
| **协议层次** | 应用层协议（基于UDP）| 网络层协议（直接封装在IP数据报中）|

### **5. BGP边界网关协议**

> [!NOTE] #BGP #边界网关协议
> BGP（Border Gateway Protocol）基于**路径向量（Path-Vector）算法**。

*   **基本概念**：
    *   在不同自治系统内，度量路由的"代价"（距离、带宽、费用等）可能不同。对于自治系统之间的路由选择，使用"代价"作为度量来寻找最佳路由是不行的。
    *   自治系统之间的路由选择必须考虑相关**策略**（政治、经济、安全等），而不是简单的最短路径。
    *   BGP只能是力求寻找一条能够到达目的网络且**比较好的路由**（不能兜圈子），而并非要寻找一条最佳路由。
    *   BGP发言人（AS边界路由器）除了运行BGP外，还必须运行自己所在自治系统所使用的内部网关协议IGP（例如OSPF或RIP）。
    *   BGP发言人交换**网络可达性的信息**（要到达某个网络所要经过的一系列自治系统，即**AS路径**）。#AS路径
    *   BGP发言人互相交换了网络可达性的信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各自治系统的较好的路由。也就是构造出树形结构、不存在回路的自治系统连通图。
    *   BGP是**应用层协议**，它**基于TCP**（端口号179）来交换路由信息，确保可靠传输。
*   **特点**：
    *   BGP交换路由信息的结点数量级是自治系统的数量级，要比这些自治系统中的网络数少很多，有效减小路由表规模。
    *   一个自治系统中BGP发言人（或边界路由器）的数目是很少的。使得自治系统之间的路由选择不致过分复杂。
    *   BGP支持CIDR。BGP的路由表包含分层的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统（AS路径）。
    *   在BGP刚运行时，BGP的邻站交换整个BGP路由表。但以后只需在发生变化时更新有变化的部分（**增量更新**）。这对于节省网络带宽和减少路由器的处理开销都有好处。
*   **BGP-4四种报文**：
    1.  **OPEN（打开）报文**：与相邻的另一个BGP发言人建立关系，使通信初始化。
    2.  **UPDATE（更新）报文**：用来通告某一路由的信息，以及列出要撤销的多条路由。
    3.  **KEEPALIVE（保持活跃）报文**：用来周期性地证实邻站的连通性。
    4.  **NOTIFICATION（通知）报文**：用来发送检测到的差错。
*   **工作过程**：
    *   在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的"BGP发言人"。
    *   不同自治系统BGP发言人交换路由信息，首先建立TCP连接（端口号为179）。
    *   在TCP连接上交换BGP报文以建立BGP会话。
    *   BGP会话交换路由信息（例如，增加新的路由，或撤销过时的路由，以及报告出错的情况等）。
    *   在TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站（neighbor）或对等站（peer）**。
*   **BGP报文**（了解）：
    *   **BGP报文通用首部**（19字节）：包含标记字段（鉴别）、长度字段、类型字段。
    *   **OPEN报文**（6个字段）：版本、自治系统号、保持时间、BGP标识符、可选参数长度、可选参数。
    *   **UPDATE报文**（5个字段）：撤销路由长度、撤销的路由、路径属性总长度、路径属性、网络层可达性信息NLRI。
    *   **KEEPALIVE报文**：仅包含19字节长的通用首部。
    *   **NOTIFICATION报文**（3个字段）：差错代码、差错子代码、差错数据。

## **04-6 IP组播**

### **1. 组播的概念**
*   **基本概念**：#组播 #Multicast
    *   源计算机一次发送的单个分组可以抵达用一个组地址标识的若干目标主机，并被它们正确接收。它是一种**"一对多"**的通信方式。
    *   多播地址标识一个多播组。主机可以选择加入或离开一个组，一台主机可同时属于多个组。
*   **过程**：
    *   主机通过**IGMP协议（因特网组管理协议）**加入组播组。IGMP通知本地网络上的路由器关于要接收发送给某个组播组的分组的愿望。
    *   通过扩展路由器的路由选择和转发功能，在路由器互联的支持硬件组播的网络上面实现因特网组播。
*   **特点**：
    *   主机组播时数据只需发送一次就可发送到所有接收者，减轻网络的负载和发送者的负担，有效节约网络带宽。
    *   组播仅应用于**UDP**。TCP是面向连接的协议（一对一地发送），不支持组播。
    *   组播需要路由器的支持才能实现。能够运行组播协议的路由器称为**组播路由器**。

### **2. IP组播地址**
*   **范围**：#IP组播地址
    *   组播使用**D类地址**格式。D类IP地址范围为`224.0.0.0`到`239.255.255.255`。
    *   D类IP地址标志一个组播组。
*   **特点**：
    *   组播数据报采用**尽力而为（Best-Effort）**的最大努力交付，不提供可靠交付。
    *   **组播地址只能用于目的地址，而不能用于源地址**。
    *   组播数据报不会产生ICMP差错报文。若在PING命令后面键入组播地址，将永远不会收到ICMP回答。
    *   不是所有D类地址都可作为组播地址。例如`224.0.0.0`保留，`224.0.0.1`代表所有主机组，`224.0.0.2`代表所有路由器组。
*   **IP组播分类**：
    *   在本局域网上进行硬件组播。
    *   在因特网的范围内进行组播（需要多播路由协议）。

### **3. IP地址与以太网多播地址**
*   **以太网多播MAC地址块范围**：`01-00-5E-00-00-00` 到 `01-00-5E-7F-FF-FF`。
*   **映射关系**：#硬件多播 #MAC多播 #IP到MAC映射
    *   MAC地址和组播IP地址映射关系**不是唯一对应**的。
    *   32位IP组播地址可以变化的28位中，只映射其中**低23位**到MAC多播地址的低23位，剩下5位自由变化的。
    *   **映射规则**：以太网多播MAC地址的**高25位固定为`01-00-5E`**（十六进制），**低23位**来自IP多播地址的低23位。

        ```plaintext
                  D 类 IP 地址 (32位)
                  1110 |  网络号 (28 bits)
                 
                  (最高5位)
                 oooo'oooi oooo'ooob dioi'iiio d  <IP多播地址
                        ^
                        |
                        |      (最低23位映射到MAC地址)
                        V
            48 位以太网多播地址
            01-00-5E | rrrrrrr rrrrrrr rrrrrrr (低23位来自D类IP地址)
            (固定高25位)
        ```

        图4-54 D类IP地址与以太网多播地址的映射关系
    *   **示例**：组播IP地址为`224.215.145.230`，二进制`11100000.11010111.10010001.11100110`。只映射IP地址后23位，即`1010111.10010001.11100110`（十六进制为`57-91-E6`）。在前面加上固定首部`01-00-5E`。结果是以太网多播MAC地址`01-00-5E-57-91-E6`。

## **04-7 移动IP**

### **1. 移动IP的概念**
*   **概念**：#移动IP
    *   移动结点以固定的网络IP地址实现跨越不同网段的漫游，并保证基于网络IP的网络权限在漫游过程中不发生改变。
    *   在移动IP中，每个移动结点都有一个唯一的**归属地址（Home Address, HoA）**，当移动结点移动时，归属地址是不变的。**归属代理（Home Agent, HA）**维护移动结点当前的**转交地址（Care-of Address, CoA）**信息。
*   **目标**：
    *   分组能够自动地投递给移动结点。即使其连接点从一个网络或子网改变到另一个网络或子网，主机也能继续保持通信。
    *   一个移动结点可以在不改变其IP地址的情况下改变其驻留位置。
*   **功能实体**：
    *   **移动结点（Mobile Node, MN）**：#移动结点 具有永久IP地址的设备。
    *   **归属代理（Home Agent, HA）**：#归属代理 部署在移动结点的**归属网络**中，代表移动结点办事，把数据转交（隧道封装）给移动结点。
    *   **外部代理（Foreign Agent, FA）**：#外部代理 部署在移动结点当前所处的**外部网络**中，帮助移动结点完成移动管理功能，为移动结点提供**转交地址（CoA）**。
*   **转交地址（Care-of Address, CoA）**：#转交地址 移动结点在外部网络中获得的临时IP地址，表示其当前的位置。移动IP的转交地址可以是外部代理的地址（**外部代理转交地址**）或移动结点自己动态配置的一个地址（**共存转交地址**）。
*   **移动IP与动态IP的区别**：
    *   **动态IP**指局域网中的计算机可以通过网络中的DHCP服务器动态地获得一个IP地址，不需要用户在计算机的网络设置中指定IP地址。每次获得IP地址后，其逻辑身份会改变。
    *   **移动IP**允许移动结点在**不改变其永久IP地址**（归属地址）的情况下移动到不同的网络，同时保持通信。

### **2. 移动IP的通信过程**
1.  **移动结点发现**：#移动IP发现
    *   当移动结点漫游到外地网络时，它会发现当地的外部代理（或自己获取转交地址）。
    *   移动结点在本地网时，按TCP方式进行通信。
2.  **移动结点注册**：#移动IP注册
    *   移动结点需要向**归属代理**注册当前的位置地址，这个位置地址就是**转交地址（CoA）**。
    *   当移动结点得到一个新的转交地址时，通过**绑定更新**向本地代理进行注册，以便让本地代理即时了解移动结点的当前位置。
3.  **隧道传输（Tunneling）**：#隧道传输
    *   通信对端（Correspondent Node, CN）向移动结点的**归属地址**（HoA）发送IP分组。
    *   归属代理接收到发给移动结点的IP分组后，会**截获**这些分组。
    *   归属代理构建一条通向转交地址的**隧道**，将截获的发给移动节点的IP分组**封装**在一个新的IP数据报中，目的地址是转交地址，然后通过隧道发送。
4.  **解封装与转发**：#解封装
    *   在转交地址处（或外部代理），解除隧道封装，恢复出原始的IP分组，最后送到移动结点，这样移动结点在外网就能够收到这些送给它的IP分组了。
5.  **移动结点发送数据**：
    *   移动结点在外网通过外网的路由器或者外部代理向通信对端发送IP数据报。此时，源IP地址可以是归属地址，也可以是转交地址。
6.  **位置更新**：当移动节点来到另一外网，只需要向本地代理更新注册的转交地址，就继续通信。
7.  **注销**：当移动节点回到本地网时，移动节点向本地代理注销转交地址，移动节点将使用传统的TCP/IP方式进行通信。
*   **移动IP为移动主机设置两个IP地址**：主地址（归属地址）和辅地址（转交地址）。移动主机在本地网时，使用的是主地址。当移动到另一网络时，需要辅助的临时地址，主地址仍然保持不变。当从外网移回本地网时，辅地址改变或撤销，主地址保持不变。
*   **返程路由优化**：#返程路由优化
    *   传统的移动IP存在"三角路由"问题，即移动节点发出的数据可以直接到达通信对端，但通信对端发回的数据必须先到达归属代理，再由归属代理隧道转发到移动节点。
    *   路由优化技术允许移动节点将自己的转交地址告知通信对端，通信对端可以直接向转交地址发送数据，避免了三角路由的低效。

## **04-8 网络层设备**

### **1. 冲突域和广播域**
| 设备               | 层级  | 隔离冲突域                          | 隔离广播域                  | **双工模式** |
| :--------------- | :-- | :----------------------------- | :--------------------- | :------- |
| **集线器 (Hub)**    | 物理层 | 否（广播式传输，所有端口属于同一冲突域）           | 否（广播帧会被泛洪到所有端口）        | 半双工      |
| **交换机 (Switch)** | 链路层 | 是（每个端口是一个独立的冲突域，基于MAC地址表直接转发。） | 否（广播帧会被泛洪到所有端口，VLAN除外） | 全双工（默认）  |
| **路由器 (Router)** | 网络层 | 是（每个接口是一个独立的冲突域，通过路由表跨网转发）     | 是（广播帧不会穿透路由器）          | 全双工      |

*   **冲突域（Collision Domain）**：#冲突域 指在共享介质网络中，所有可能发生冲突（数据包同时发送导致数据损坏）的节点集合。冲突域的大小会影响网络性能，越小越好。
    *   **集线器**是物理层设备，它连接的所有端口都属于同一个冲突域。
    *   **交换机**是数据链路层设备，它的每个端口都是一个独立的冲突域，通过存储转发避免端口间的冲突。
    *   **路由器**是网络层设备，它的每个接口（端口）都是一个独立的冲突域。
*   **广播域（Broadcast Domain）**： #广播域 指广播消息能够到达的所有节点集合。广播域越大， #广播风暴 的风险越高。
    *   **集线器和交换机**都不能隔离广播域（广播帧会被它们泛洪转发到所有端口）。**（但配置了VLAN的交换机可以隔离广播域，VLAN内的广播只在VLAN内转发）**
    *   **路由器**可以隔离广播域，它不会转发广播帧到其他网络，是**隔离广播域的唯一网络层设备**。

### **2. 路由器的组成和功能**
*   **路由器的本质**：#路由器本质
    *   连接不同的网络（连接异构网络）并完成路由转发。
    *   在多个逻辑网络（即多个广播域）互联时必须使用路由器。
*   **路由器的功能（过程）**：#路由器功能
    *   源主机向目标主机发送数据报时，路由器先检查源主机与目标主机是否连接在同一个网络上。
    *   如果在一个网络上，直接交付而无须通过路由器。如果不在同一个网络上，路由器按照转发表（路由表）指出的路由将数据报转发给下一个路由器，这称为间接交付。
    *   在一个网络中传输数据无须路由器的参与，而跨网络通信必须通过路由器进行转发。路由器隔离了广播域。
*   **路由器的结构**：#路由器组成

```plaintext
┌───────────────────────┐
│     路由选择处理器    │ (控制平面)
│   (路由选择协议, 路由选择) │
└──────────┬───────────┘
           │
       ┌───┴───┐
       │交换结构│
       └───┬───┘
┌──────────┴───────────┐
│ 输入端口            输出端口 │
└───────────────────────┘
```

   = 1.  **路由选择部分（控制平面）**：#控制平面
        *   核心构件是**路由选择处理机（路由处理器）**。
        *   路由选择处理机根据路由选择协议构造出**路由表**，同时经常或定期地和相邻路由器交换路由信息而不断更新和维护路由表。
    2.  **分组转发部分（数据平面）**：#数据平面
        *   由**交换结构**、一组**输入端口**和一组**输出端口**组成。
        *   **输入端口**：在从物理层接收到的比特流中提取出数据链路层帧，从帧中提取出网络层数据报，然后将分组送入网络层模块。如果接收的分组是路由器之间交换路由信息的分组，则把这种分组送交路由器的路由选择部分中的路由选择处理器。如果接收的是数据分组，则按照分组首部中的目的地址查找转发表，根据得到的结果，分组就经过交换结构到达合适的输出端口。当一个分组正在查找转发表时，紧跟着从这个输入端口收到另一个分组，这个分组必须在队列中排队，产生一定时延。
        *   **输出端口**：交换结构传送过来的分组先进行缓存，数据链路层处理模块将给分组加上数据链路层的首部和尾部，交给物理层后发送到外部线路。
        *   **交换结构**：#交换结构 是路由器的关键部件，根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。交换结构本身就是一个网络。常见的交换方法：通过存储器进行交换、通过总线进行交换和通过互联网络进行交换。
*   **路由器和网桥的重要区别**：
    *   网桥与高层协议无关（工作在数据链路层），而路由器是面向协议的（工作在网络层），它依据网络地址进行操作，并进行路径选择、分段、帧格式转换、对数据报的生存时间和流量进行控制等。

### **3. 路由表与分组转发**
*   **路由表（Routing Table）**：#路由表
    *   由路由器的**控制平面（路由处理器）**基于路由算法和协议生成和维护。
    *   标准的路由表有4个项目：目的网络IP地址、子网掩码、下一跳IP地址、出接口。
    *   可用默认路由代替所有具有相同"下一跳"的项目，并将默认路由设置得比其它的优先级低。
    *   路由表是**软件实现**的，用于**路由选择（路径计算）**。
    *   它是根据路由选择算法得出的，需要对网络拓扑变化的计算最优化。
*   **转发表（Forwarding Information Base, FIB）**：#转发表 #FIB
    *   由路由器的**数据平面**使用，是路由表经过**优化和硬件加速**的版本。
    *   转发表的结构应当使查找过程最优化（通常采用硬件实现）。
    *   通常包含目的网络前缀到出接口以及下一跳的直接映射，以实现**快速查找**。
    *   这是进行**分组转发**的依据。
*   **转发和路由选择的区别**：
    *   **"转发"**是路由器根据转发表把收到的IP数据报从合适的端口转发出去，仅涉及**一个路由器**，是**数据平面**的动作。
    *   **"路由选择"**涉及**多个路由器**协同工作的结果，是路由器的**控制平面**按照路由算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由，并由此构造出整个路由表。
    *   路由表用软件来实现；转发表用软件来实现，也可以用特殊的硬件来实现。

---
